  <!-- Page Header - Navbar ke niche directly -->
  <div class="page-header">
    <h2 class="page-title">Project Requirements</h2>
  </div>

  <!-- ‚úÖ Requirements Table Card -->
  <div class="card">
    
    <!-- ‚úÖ Header with All Action Buttons -->
    <div class="card-header">
      <!-- ‚úÖ Left side: Action Buttons -->
      <div class="action-buttons">
        <button class="download-template-btn" (click)="downloadTemplate()" title="Download Excel Template">
          üì• Download Template
        </button>
        <button class="import-requirements-btn" (click)="openImportPopup()" title="Import Requirements from Excel">
          üì§ Import Requirements
        </button>
        <button class="add-btn" (click)="openAddRequirementPopup()" title="Add New Requirement">
          + Add Requirement
        </button>
        <button class="filter-btn" (click)="openFilterPopup()" title="Filter Requirements">
          üîç Filter Requirements
        </button>
      </div>
    </div>

    <!-- ‚úÖ Requirements Display Area -->
    <div class="requirements-content">
      <!-- Message when no filters applied -->
      <div *ngIf="!filtersApplied" class="placeholder-message">
        <div class="message-content">
          <h3>Apply Filters to View Requirements</h3>
          <p>Click the "Filter Requirements" button to apply filters and display project requirements.</p>
        </div>
      </div>

      <div *ngIf="filtersApplied" class="table-container-wrapper">
        <!-- Table Header with Search -->
        <div class="table-header-section">
          <div class="project-header" *ngIf="selectedProjectId && project">
            <h3>Requirements for {{ project?.project_name }}</h3>
          </div>
          
          <!-- Search Box - Properly positioned on the right side -->
          <div class="search-box-right">
            <input type="text" [(ngModel)]="searchText" (input)="filterRequirements()" 
                   placeholder="Search requirements..." class="search-input-right">
          </div>
        </div>

        <!-- ‚úÖ Table Container with proper height -->
        <div class="table-scroll-container">
          <table class="styled-table">
            <thead>
              <tr>
                <th class="col-sno">S. No.</th>
                <th class="col-title">Title</th>
                <th>Priority</th>
                <th>Reported Date</th>
                <th>Expected Delivery</th>
                <th>Actual Delivery</th>
                <th>Status</th>
                <th class="col-boolean">Is Developed</th>
                <th class="col-boolean">Is Tested</th>
                <th class="col-boolean">Is Delivered</th>
                <th class="col-boolean">UAT Testing Done</th>
                <th class="col-boolean">Bug Raised After UAT</th>
                <th class="col-boolean">Bug Fixed</th>
                <th class="actions-header">Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- ‚úÖ Updated to use paginatedRequirements with proper serial number -->
              <tr *ngFor="let requirement of paginatedRequirements(); let i = index">
                <td class="col-sno">{{ (currentPage - 1) * pageSize + i + 1 }}</td>
                
                <!-- Clickable Title Column with Text Wrapping -->
                <td class="col-title">
                  <span class="clickable-title" 
                        (click)="openRequirementDetails(requirement)"
                        (mouseenter)="requirement.isHovered = true"
                        (mouseleave)="requirement.isHovered = false"
                        [class.title-hover]="requirement.isHovered">
                    {{ requirement.requirement_title }}
                  </span>
                </td>

                <td>
                  <span class="priority-badge {{ requirement.priority.toLowerCase() }}">
                    {{ requirement.priority }}
                  </span>
                </td>

                <td>{{ requirement.reported_date | date:'mediumDate' }}</td>
                <td>{{ requirement.expected_delivery | date:'mediumDate' }}</td>
                <td>{{ requirement.actual_delivery ? (requirement.actual_delivery | date:'mediumDate') : 'Pending' }}</td>

                <td>
                  <span class="status-badge {{ getRequirementStatus(requirement) }}">
                    {{ getRequirementStatus(requirement) }}
                  </span>
                </td>

                <td class="col-boolean">
                  <span [ngClass]="requirement.is_developed ? 'icon-yes' : 'icon-no'">
                    {{ requirement.is_developed ? '‚úî' : '‚úñ' }}
                  </span>
                </td>
                <td class="col-boolean">
                  <span [ngClass]="requirement.is_tested ? 'icon-yes' : 'icon-no'">
                    {{ requirement.is_tested ? '‚úî' : '‚úñ' }}
                  </span>
                </td>
                <td class="col-boolean">
                  <span [ngClass]="requirement.is_delivered ? 'icon-yes' : 'icon-no'">
                    {{ requirement.is_delivered ? '‚úî' : '‚úñ' }}
                  </span>
                </td>
                <td class="col-boolean">
                  <span [ngClass]="requirement.uat_testing ? 'icon-yes' : 'icon-no'">
                    {{ requirement.uat_testing ? '‚úî' : '‚úñ' }}
                  </span>
                </td>
                <td class="col-boolean">
                  <span [ngClass]="requirement.bug_raised_by_client_after_uat ? 'icon-yes' : 'icon-no'">
                    {{ requirement.bug_raised_by_client_after_uat ? '‚úî' : '‚úñ' }}
                  </span>
                </td>
                <td class="col-boolean">
                  <span [ngClass]="requirement.bug_fixed ? 'icon-yes' : 'icon-no'">
                    {{ requirement.bug_fixed ? '‚úî' : '‚úñ' }}
                  </span>
                </td>

                <td class="actions">
                  <button class="edit-btn" (click)="editRequirement(requirement)" title="Edit Requirement">‚úèÔ∏è</button>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- ‚úÖ Pagination -->
        <div class="pagination-container" *ngIf="filteredRequirements.length > 0">
          <div class="pagination-summary">
            Showing {{ getStartIndex() }}-{{ getEndIndex() }} of {{ filteredRequirements.length }} records
          </div>
          <div class="pagination-controls">
            <button 
              class="pagination-btn" 
              [disabled]="currentPage === 1" 
              (click)="goToPage(currentPage - 1)">
              Previous
            </button>
            
            <button 
              *ngFor="let page of getVisiblePages()" 
              class="pagination-btn" 
              [class.active]="page === currentPage"
              (click)="goToPage(page)">
              {{ page }}
            </button>
            
            <button 
              class="pagination-btn" 
              [disabled]="currentPage === totalPages()" 
              (click)="goToPage(currentPage + 1)">
              Next
            </button>
          </div>
        </div>

        <div *ngIf="filteredRequirements.length === 0 && filtersApplied" class="no-records">
          <div *ngIf="searchText">
            No requirements match your search criteria.
          </div>
          <div *ngIf="!searchText">
            No requirements found for the applied filters.
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Notification -->
  <div *ngIf="showSuccessMessage" class="success-notification">
    <span>{{ successMessage }}</span>
    <button class="close-notification" (click)="hideSuccessMessage()">√ó</button>
  </div>

  <!-- Error Notification -->
  <div *ngIf="showErrorMessage" class="error-notification">
    <span>{{ errorMessage }}</span>
    <button class="close-notification" (click)="hideErrorMessage()">√ó</button>
  </div>

  <!-- Requirement Details Popup -->
  <div class="popup" *ngIf="showRequirementDetailsPopup">
    <div class="popup-content requirement-details-popup">
      <div class="popup-header">
        <h3>Requirement Details</h3>
        <button class="close-btn" (click)="closeRequirementDetails()">‚úñ</button>
      </div>

      <div class="requirement-details-cards" *ngIf="selectedRequirement">
        <!-- Basic Information Card -->
        <div class="detail-card">
          <div class="card-header">
            <div class="card-icon">üìã</div>
            <h4>Basic Information</h4>
          </div>
          <div class="card-content">
            <div class="detail-row">
              <div class="detail-label">Title:</div>
              <div class="detail-value">{{ selectedRequirement.requirement_title }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Description:</div>
              <div class="detail-value description-text">{{ selectedRequirement.requirement }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Priority:</div>
              <div class="detail-value">
                <span class="priority-badge {{ selectedRequirement.priority.toLowerCase() }}">
                  {{ selectedRequirement.priority }}
                </span>
              </div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Status:</div>
              <div class="detail-value">
                <span class="status-badge {{ getRequirementStatus(selectedRequirement) }}">
                  {{ getRequirementStatus(selectedRequirement) }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Dates Card -->
        <div class="detail-card">
          <div class="card-header">
            <div class="card-icon">üìÖ</div>
            <h4>Dates</h4>
          </div>
          <div class="card-content">
            <div class="detail-row">
              <div class="detail-label">Reported Date:</div>
              <div class="detail-value">{{ selectedRequirement.reported_date | date:'mediumDate' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Expected Delivery:</div>
              <div class="detail-value">{{ selectedRequirement.expected_delivery | date:'mediumDate' }}</div>
            </div>
            <div class="detail-row">
              <div class="detail-label">Actual Delivery:</div>
              <div class="detail-value">{{ selectedRequirement.actual_delivery ? (selectedRequirement.actual_delivery | date:'mediumDate') : 'Pending' }}</div>
            </div>
          </div>
        </div>

        <!-- Development Status Card -->
        <div class="detail-card">
          <div class="card-header">
            <div class="card-icon">‚öôÔ∏è</div>
            <h4>Development Status</h4>
          </div>
          <div class="card-content">
            <div class="status-grid">
              <div class="status-item" [class.status-completed]="selectedRequirement.is_developed">
                <span class="status-icon">{{ selectedRequirement.is_developed ? '‚úÖ' : '‚è≥' }}</span>
                <span class="status-text">Developed</span>
              </div>
              <div class="status-item" [class.status-completed]="selectedRequirement.is_tested">
                <span class="status-icon">{{ selectedRequirement.is_tested ? '‚úÖ' : '‚è≥' }}</span>
                <span class="status-text">Tested</span>
              </div>
              <div class="status-item" [class.status-completed]="selectedRequirement.is_delivered">
                <span class="status-icon">{{ selectedRequirement.is_delivered ? '‚úÖ' : '‚è≥' }}</span>
                <span class="status-text">Delivered</span>
              </div>
            </div>
          </div>
        </div>

        <!-- UAT & Bug Tracking Card -->
        <div class="detail-card">
          <div class="card-header">
            <div class="card-icon">üêõ</div>
            <h4>UAT & Bug Tracking</h4>
          </div>
          <div class="card-content">
            <div class="status-grid">
              <div class="status-item" [class.status-completed]="selectedRequirement.uat_testing">
                <span class="status-icon">{{ selectedRequirement.uat_testing ? '‚úÖ' : '‚è≥' }}</span>
                <span class="status-text">UAT Testing</span>
              </div>
              <div class="status-item" [class.status-pending]="selectedRequirement.bug_raised_by_client_after_uat">
                <span class="status-icon">{{ selectedRequirement.bug_raised_by_client_after_uat ? '‚ö†Ô∏è' : '‚úÖ' }}</span>
                <span class="status-text">Bug Raised</span>
              </div>
              <div class="status-item" [class.status-completed]="selectedRequirement.bug_fixed">
                <span class="status-icon">{{ selectedRequirement.bug_fixed ? '‚úÖ' : '‚è≥' }}</span>
                <span class="status-text">Bug Fixed</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="cancel-btn" (click)="closeRequirementDetails()">Close</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Requirement Popup -->
  <div class="popup" *ngIf="showRequirementPopup">
    <div class="popup-content">
      <div class="popup-header">
        <h3>{{ isEditMode ? 'Edit Requirement' : 'Add Requirement' }}</h3>
        <button class="close-btn" (click)="closeRequirementPopup()">‚úñ</button>
      </div>

      <form (ngSubmit)="saveRequirement()" class="form-grid">
        <!-- Project Selection -->
        <label>Project *</label>
        <div class="select-wrapper">
          <select [(ngModel)]="newRequirement.project" name="project" [class.error]="formErrors.project">
            <option value="">Select Project</option>
            <option *ngFor="let project of allProjects" [value]="project.id">{{ project.project_name }}</option>
          </select>
        </div>
        <div *ngIf="formErrors.project" class="field-error">{{ formErrors.project }}</div>

        <!-- Title -->
        <label>Requirement Title *</label>
        <input type="text" [(ngModel)]="newRequirement.requirement_title" name="requirement_title" 
               [class.error]="formErrors.requirement_title" />
        <div *ngIf="formErrors.requirement_title" class="field-error">{{ formErrors.requirement_title }}</div>

        <!-- Description -->
        <label>Requirement Description *</label>
        <textarea [(ngModel)]="newRequirement.requirement" name="requirement" rows="3" 
                  [class.error]="formErrors.requirement"></textarea>
        <div *ngIf="formErrors.requirement" class="field-error">{{ formErrors.requirement }}</div>

        <!-- Priority -->
        <label>Priority *</label>
        <div class="select-wrapper">
          <select [(ngModel)]="newRequirement.priority" name="priority" [class.error]="formErrors.priority">
            <option value="">Select Priority</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
            <option value="Critical">Critical</option>
          </select>
        </div>
        <div *ngIf="formErrors.priority" class="field-error">{{ formErrors.priority }}</div>

        <!-- Dates -->
        <label>Reported Date *</label>
        <input type="date" [(ngModel)]="newRequirement.reported_date" name="reported_date" 
               [class.error]="formErrors.reported_date" />
        <div *ngIf="formErrors.reported_date" class="field-error">{{ formErrors.reported_date }}</div>

        <label>Expected Delivery</label>
        <input type="date" [(ngModel)]="newRequirement.expected_delivery" name="expected_delivery" />

        <label>Actual Delivery</label>
        <input type="date" [(ngModel)]="newRequirement.actual_delivery" name="actual_delivery" />

        <!-- Boolean fields -->
        <div class="boolean-fields">
          <div class="checkbox-field">
            <input type="checkbox" [(ngModel)]="newRequirement.is_developed" name="is_developed" />
            <label>Is Developed</label>
          </div>
          <div class="checkbox-field">
            <input type="checkbox" [(ngModel)]="newRequirement.is_tested" name="is_tested" />
            <label>Is Tested</label>
          </div>
          <div class="checkbox-field">
            <input type="checkbox" [(ngModel)]="newRequirement.is_delivered" name="is_delivered" />
            <label>Is Delivered</label>
          </div>
          <div class="checkbox-field">
            <input type="checkbox" [(ngModel)]="newRequirement.uat_testing" name="uat_testing" />
            <label>UAT Testing Done</label>
          </div>
          <div class="checkbox-field">
            <input type="checkbox" [(ngModel)]="newRequirement.bug_raised_by_client_after_uat" name="bug_raised_by_client_after_uat" />
            <label>Bug Raised After UAT</label>
          </div>
          <div class="checkbox-field">
            <input type="checkbox" [(ngModel)]="newRequirement.bug_fixed" name="bug_fixed" />
            <label>Bug Fixed</label>
          </div>
        </div>

        <div *ngIf="apiErrorMessage" class="api-error-message">{{ apiErrorMessage }}</div>

        <div class="form-actions">
          <button type="submit" class="save-btn">{{ isEditMode ? 'Update' : 'Save' }}</button>
          <button type="button" class="cancel-btn" (click)="closeRequirementPopup()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Filter Requirements Popup -->
  <div class="popup" *ngIf="showFilterPopup">
    <div class="popup-content">
      <div class="popup-header">
        <h3>Filter Requirements</h3>
        <button class="close-btn" (click)="closeFilterPopup()">‚úñ</button>
      </div>

      <form class="form-grid">
        <!-- Project Filter Only -->
        <div class="form-group">
          <label for="projectSelect">Project</label>
          <div class="select-wrapper">
            <select id="projectSelect" [(ngModel)]="selectedProjectId" name="projectSelect" class="form-control">
              <option value="">All Projects</option>
              <option *ngFor="let project of allProjects" [value]="project.id">{{ project.project_name }}</option>
            </select>
          </div>
        </div>

        <!-- Priority Filter -->
        <div class="form-group">
          <label for="priorityFilter">Priority</label>
          <div class="select-wrapper">
            <select id="priorityFilter" [(ngModel)]="selectedPriority" name="priorityFilter" class="form-control">
              <option value="">All Priorities</option>
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
              <option value="Critical">Critical</option>
            </select>
          </div>
        </div>

        <!-- Boolean Filters -->
        <div class="boolean-filters">
          <div class="checkbox-field">
            <input type="checkbox" [(ngModel)]="filterIsDeveloped" name="filterIsDeveloped" />
            <label>Is Developed</label>
          </div>
          <div class="checkbox-field">
            <input type="checkbox" [(ngModel)]="filterIsTested" name="filterIsTested" />
            <label>Is Tested</label>
          </div>
          <div class="checkbox-field">
            <input type="checkbox" [(ngModel)]="filterIsDelivered" name="filterIsDelivered" />
            <label>Is Delivered</label>
          </div>
        </div>
      </form>

      <div class="form-actions">
        <button type="button" class="save-btn" (click)="applyFilters()">Apply Filters</button>
        <button type="button" class="cancel-btn" (click)="closeFilterPopup()">Cancel</button>
        <button type="button" class="clear-btn" (click)="clearFilters()">Clear Filters</button>
      </div>
    </div>
  </div>

  <!-- Import Requirements Popup -->
  <div class="popup" *ngIf="showImportPopup">
    <div class="popup-content">
      <div class="popup-header">
        <h3>Import Requirements from Excel</h3>
        <button class="close-btn" (click)="closeImportPopup()">‚úñ</button>
      </div>

      <div class="import-instructions">
        <h4>Instructions:</h4>
        <ul>
          <li>Download the template first to ensure correct format</li>
          <li>Fill in the required fields marked with *</li>
          <li>For boolean fields, use TRUE or FALSE only</li>
          <li>Date format must be YYYY-MM-DD</li>
          <li>Priority must be one of: Low, Medium, High, Critical</li>
        </ul>
      </div>

      <div class="file-upload-area" [class.drag-over]="isDragOver" 
           (drop)="onFileDrop($event)" 
           (dragover)="onDragOver($event)" 
           (dragleave)="onDragLeave($event)">
        <input type="file" #fileInput (change)="onFileSelected($event)" accept=".xlsx,.xls" hidden>
        
        <div class="upload-content" *ngIf="!selectedFile">
          <div class="upload-icon">üìÅ</div>
          <p>Drag & drop your Excel file here</p>
          <p class="upload-or">or</p>
          <button class="browse-btn" (click)="fileInput.click()">Browse Files</button>
          <p class="file-types">Supported formats: .xlsx, .xls</p>
        </div>

        <div class="file-selected" *ngIf="selectedFile">
          <div class="file-info">
            <div class="file-icon">üìÑ</div>
            <div class="file-details">
              <p class="file-name">{{ selectedFile.name }}</p>
              <p class="file-size">{{ getFileSize(selectedFile.size) }}</p>
            </div>
            <button class="remove-file" (click)="removeFile()">‚úñ</button>
          </div>
        </div>
      </div>

      <!-- Validation Errors -->
      <div *ngIf="importErrors.length > 0" class="import-errors">
        <h4>Validation Errors:</h4>
        <div class="error-list">
          <div *ngFor="let error of importErrors" class="error-item">
            {{ error }}
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="save-btn" (click)="confirmImport()" [disabled]="!selectedFile || importErrors.length > 0">
          Import Requirements
        </button>
        <button type="button" class="cancel-btn" (click)="closeImportPopup()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Import Confirmation Popup -->
  <div class="popup" *ngIf="showImportConfirmation">
    <div class="popup-content">
      <div class="popup-header">
        <h3>Confirm Import</h3>
        <button class="close-btn" (click)="closeImportConfirmation()">‚úñ</button>
      </div>

      <div class="confirmation-message">
        <p>Are you sure you want to import {{ getRequirementCount() }} requirements?</p>
        <p class="warning-text">This action cannot be undone.</p>
      </div>

      <div class="form-actions">
        <button type="button" class="save-btn" (click)="importRequirements()">Yes, Import</button>
        <button type="button" class="cancel-btn" (click)="closeImportConfirmation()">Cancel</button>
      </div>
    </div>
  </div>