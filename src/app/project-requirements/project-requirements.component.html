<div class="requirements-container">
  <div class="header">
    <h2>Project Requirements</h2>
    <button class="add-btn" (click)="openAddRequirementPopup()" [disabled]="!selectedProjectId">+ Add Requirement</button>
  </div>

  <!-- Client and Project Filters -->
  <div class="filters-card card">
    <h3>Filter Requirements</h3>
    <div class="filter-form">
      <div class="form-group">
        <label for="clientSelect">Client *</label>
        <select id="clientSelect" [(ngModel)]="selectedClientId" (change)="onClientChange()" class="form-control">
          <option value="">Select Client</option>
          <option *ngFor="let client of clients" [value]="client.id">{{ client.client_name }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="projectSelect">Project *</label>
        <select id="projectSelect" [(ngModel)]="selectedProjectId" (change)="onProjectChange()" class="form-control" [disabled]="!selectedClientId">
          <option value="">Select Project</option>
          <option *ngFor="let project of filteredProjects" [value]="project.id">{{ project.project_name }}</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Requirements Display Area -->
  <div *ngIf="selectedProjectId && project" class="requirements-content">
    <!-- ‚úÖ Fixed the heading bug - removed extra parentheses -->
    <div class="project-header">
      <h3>Requirements for {{ project?.project_name }} {{ selectedClientName ? '(' + selectedClientName + ')' : '' }}</h3>
    </div>

    <div class="card table-card">

      <!-- Search and Filter Controls -->
      <div class="search-filter-controls card">
        <div class="search-box">
          <input type="text" [(ngModel)]="searchText" (input)="filterRequirements()" placeholder="Search requirements..." class="search-input">
        </div>
        <div class="filter-control">
          <label for="priorityFilter">Priority Filter:</label>
          <select id="priorityFilter" [(ngModel)]="selectedPriority" (change)="filterRequirements()" class="filter-select">
            <option value="">All Priorities</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
            <option value="Critical">Critical</option>
          </select>
        </div>
      </div>

      <!-- ‚úÖ Table Container without vertical scroll -->
      <div class="table-scroll-container">
        <table class="styled-table">
          <thead>
            <tr>
              <th class="col-sno">S. No.</th>
              <th class="col-title">Title</th>
              <th>Priority</th>
              <th>Reported Date</th>
              <th>Expected Delivery</th>
              <th>Actual Delivery</th>
              <th>Status</th>
              <th class="col-boolean">Is Developed</th>
              <th class="col-boolean">Is Tested</th>
              <th class="col-boolean">Is Delivered</th>
              <th class="col-boolean">UAT Testing Done</th>
              <th class="col-boolean">Bug Raised After UAT</th>
              <th class="col-boolean">Bug Fixed</th>
              <th class="actions-header">Actions</th>
            </tr>
          </thead>
          <tbody>
            <!-- ‚úÖ Updated to use paginatedRequirements with proper serial number -->
            <tr *ngFor="let requirement of paginatedRequirements(); let i = index">
              <td class="col-sno">{{ (currentPage - 1) * pageSize + i + 1 }}</td>
              
              <td class="col-title">{{ requirement.requirement_title }}</td>

              <td>
                <span class="priority-badge {{ requirement.priority.toLowerCase() }}">
                  {{ requirement.priority }}
                </span>
              </td>

              <td>{{ requirement.reported_date | date:'mediumDate' }}</td>
              <td>{{ requirement.expected_delivery | date:'mediumDate' }}</td>
              <td>{{ requirement.actual_delivery ? (requirement.actual_delivery | date:'mediumDate') : 'Pending' }}</td>

              <td>
                <span class="status-badge {{ getRequirementStatus(requirement) }}">
                  {{ getRequirementStatus(requirement) }}
                </span>
              </td>

              <td class="col-boolean">
                <span [ngClass]="requirement.is_developed ? 'icon-yes' : 'icon-no'">
                  {{ requirement.is_developed ? '‚úî' : '‚úñ' }}
                </span>
              </td>
              <td class="col-boolean">
                <span [ngClass]="requirement.is_tested ? 'icon-yes' : 'icon-no'">
                  {{ requirement.is_tested ? '‚úî' : '‚úñ' }}
                </span>
              </td>
              <td class="col-boolean">
                <span [ngClass]="requirement.is_delivered ? 'icon-yes' : 'icon-no'">
                  {{ requirement.is_delivered ? '‚úî' : '‚úñ' }}
                </span>
              </td>
              <td class="col-boolean">
                <span [ngClass]="requirement.uat_testing ? 'icon-yes' : 'icon-no'">
                  {{ requirement.uat_testing ? '‚úî' : '‚úñ' }}
                </span>
              </td>
              <td class="col-boolean">
                <span [ngClass]="requirement.bug_raised_by_client_after_uat ? 'icon-yes' : 'icon-no'">
                  {{ requirement.bug_raised_by_client_after_uat ? '‚úî' : '‚úñ' }}
                </span>
              </td>
              <td class="col-boolean">
                <span [ngClass]="requirement.bug_fixed ? 'icon-yes' : 'icon-no'">
                  {{ requirement.bug_fixed ? '‚úî' : '‚úñ' }}
                </span>
              </td>

              <td class="actions">
                <button class="edit-btn" (click)="editRequirement(requirement)" title="Edit Requirement">‚úèÔ∏è</button>
                <button class="test-case-btn" (click)="viewTestCases(requirement)" title="View Test Cases">üß™</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- ‚úÖ Pagination -->
      <div class="pagination-container" *ngIf="filteredRequirements.length > 0">
        <div class="pagination-summary">
          Showing {{ getStartIndex() }}-{{ getEndIndex() }} of {{ filteredRequirements.length }} records
        </div>
        <div class="pagination-controls">
          <button 
            class="pagination-btn" 
            [disabled]="currentPage === 1" 
            (click)="goToPage(currentPage - 1)">
            Previous
          </button>
          
          <button 
            *ngFor="let page of getVisiblePages()" 
            class="pagination-btn" 
            [class.active]="page === currentPage"
            (click)="goToPage(page)">
            {{ page }}
          </button>
          
          <button 
            class="pagination-btn" 
            [disabled]="currentPage === totalPages()" 
            (click)="goToPage(currentPage + 1)">
            Next
          </button>
        </div>
      </div>

      <div *ngIf="filteredRequirements.length === 0 && selectedProjectId" class="no-requirements">
        <div *ngIf="searchText || selectedPriority">
          No requirements match your search/filter criteria.
        </div>
        <div *ngIf="!searchText && !selectedPriority">
          No requirements found for this project.
        </div>
      </div>
    </div>
  </div>

  <!-- Message when no client/project selected -->
  <div *ngIf="!selectedProjectId" class="placeholder-message card">
    <div class="message-content">
      <h3>Select Client and Project</h3>
      <p>Select a client and project from the dropdowns above to display the project requirements.</p>
    </div>
  </div>

  <!-- Success Notification -->
  <div *ngIf="showSuccessMessage" class="success-notification">
    <span>{{ successMessage }}</span>
    <button class="close-notification" (click)="hideSuccessMessage()">√ó</button>
  </div>

  <!-- Add/Edit Requirement Popup -->
  <div class="popup" *ngIf="showRequirementPopup">
    <div class="popup-content">
      <div class="popup-header">
        <h3>{{ isEditMode ? 'Edit Requirement' : 'Add Requirement' }}</h3>
        <button class="close-btn" (click)="closeRequirementPopup()">‚úñ</button>
      </div>

      <form (ngSubmit)="saveRequirement()" class="form-grid">
        <!-- Title -->
        <label>Requirement Title *</label>
        <input type="text" [(ngModel)]="newRequirement.requirement_title" name="requirement_title" 
               [class.error]="formErrors.requirement_title" />
        <div *ngIf="formErrors.requirement_title" class="error-message">{{ formErrors.requirement_title }}</div>

        <!-- Description -->
        <label>Requirement Description *</label>
        <textarea [(ngModel)]="newRequirement.requirement" name="requirement" rows="3" 
                  [class.error]="formErrors.requirement"></textarea>
        <div *ngIf="formErrors.requirement" class="error-message">{{ formErrors.requirement }}</div>

        <!-- Priority -->
        <label>Priority *</label>
        <select [(ngModel)]="newRequirement.priority" name="priority" [class.error]="formErrors.priority">
          <option value="">Select Priority</option>
          <option value="Low">Low</option>
          <option value="Medium">Medium</option>
          <option value="High">High</option>
          <option value="Critical">Critical</option>
        </select>
        <div *ngIf="formErrors.priority" class="error-message">{{ formErrors.priority }}</div>

        <!-- Dates -->
        <label>Reported Date *</label>
        <input type="date" [(ngModel)]="newRequirement.reported_date" name="reported_date" 
               [class.error]="formErrors.reported_date" />
        <div *ngIf="formErrors.reported_date" class="error-message">{{ formErrors.reported_date }}</div>

        <label>Expected Delivery</label>
        <input type="date" [(ngModel)]="newRequirement.expected_delivery" name="expected_delivery" />

        <label>Actual Delivery</label>
        <input type="date" [(ngModel)]="newRequirement.actual_delivery" name="actual_delivery" />

        <!-- Boolean fields -->
        <div class="boolean-fields">
          <div class="checkbox-field">
            <input type="checkbox" [(ngModel)]="newRequirement.is_developed" name="is_developed" />
            <label>Is Developed</label>
          </div>
          <div class="checkbox-field">
            <input type="checkbox" [(ngModel)]="newRequirement.is_tested" name="is_tested" />
            <label>Is Tested</label>
          </div>
          <div class="checkbox-field">
            <input type="checkbox" [(ngModel)]="newRequirement.is_delivered" name="is_delivered" />
            <label>Is Delivered</label>
          </div>
          <div class="checkbox-field">
            <input type="checkbox" [(ngModel)]="newRequirement.uat_testing" name="uat_testing" />
            <label>UAT Testing Done</label>
          </div>
          <div class="checkbox-field">
            <input type="checkbox" [(ngModel)]="newRequirement.bug_raised_by_client_after_uat" name="bug_raised_by_client_after_uat" />
            <label>Bug Raised After UAT</label>
          </div>
          <div class="checkbox-field">
            <input type="checkbox" [(ngModel)]="newRequirement.bug_fixed" name="bug_fixed" />
            <label>Bug Fixed</label>
          </div>
        </div>

        <!-- Buttons -->
        <div class="form-actions">
          <button type="submit" class="save-btn">{{ isEditMode ? 'Update' : 'Save' }}</button>
          <button type="button" class="cancel-btn" (click)="closeRequirementPopup()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>