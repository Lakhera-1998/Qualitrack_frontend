<div class="testcases-container">
  <div class="header">
    <h2>Test Cases</h2>
    <div class="header-buttons">
      <!-- Updated disabled conditions -->
      <button class="template-btn" (click)="downloadTemplate()" [disabled]="!selectedProjectId">
        üì• Download Template
      </button>
      <button class="import-btn" (click)="openImportPopup()" [disabled]="!selectedProjectId">
        üì§ Import Test Cases
      </button>
      <button class="add-btn" (click)="openAddTestCasePopup()" [disabled]="!selectedProjectId">+ Add Test Case</button>
    </div>
  </div>

  <!-- Client, Project, Requirement and Category Filters in Single Row -->
  <div class="filters-card card">
    <h3>Filter Test Cases</h3>
    <div class="filter-form single-row-filters">
      <div class="form-group compact">
        <label for="clientSelect">Client *</label>
        <select id="clientSelect" [(ngModel)]="selectedClientId" (change)="onClientChange()" class="form-control">
          <option value="">Select Client</option>
          <option *ngFor="let client of clients" [value]="client.id">{{ client.client_name }}</option>
        </select>
      </div>

      <div class="form-group compact">
        <label for="projectSelect">Project *</label>
        <select id="projectSelect" [(ngModel)]="selectedProjectId" (change)="onProjectChange()" class="form-control" [disabled]="!selectedClientId">
          <option value="">Select Project</option>
          <option *ngFor="let project of filteredProjects" [value]="project.id">{{ project.project_name }}</option>
        </select>
      </div>

      <div class="form-group compact">
        <label for="requirementSelect">Requirement</label>
        <select id="requirementSelect" [(ngModel)]="selectedRequirementId" (change)="onRequirementChange()" class="form-control" [disabled]="!selectedProjectId">
          <option value="">All Requirements</option>
          <option *ngFor="let requirement of filteredRequirements" [value]="requirement.id">{{ requirement.requirement_title }}</option>
        </select>
      </div>

      <div class="form-group compact">
        <label for="categorySelect">Category</label>
        <select id="categorySelect" [(ngModel)]="selectedCategory" (change)="onCategoryChange()" class="form-control" [disabled]="!selectedProjectId">
          <option value="">All Categories</option>
          <option value="Functional">Functional</option>
          <option value="UI">UI</option>
          <option value="Performance">Performance</option>
          <option value="Security">Security</option>
          <option value="Integration">Integration</option>
          <option value="Regression">Regression</option>
        </select>
      </div>
    </div>
  </div>

  <!-- ‚úÖ UPDATED: Test Cases Display Area - Show when project is selected -->
  <div *ngIf="selectedProjectId" class="requirements-content">
    <div class="project-header">
      <h3>
        <!-- ‚úÖ UPDATED: Dynamic heading based on selection -->
        <span *ngIf="selectedRequirementId && requirement">
          Test Cases for {{ requirement?.requirement_title }}
        </span>
        <span *ngIf="!selectedRequirementId">
          All Test Cases for {{ selectedProjectName }}
        </span>
        <span *ngIf="selectedProjectName || selectedClientName">
          ({{ selectedProjectName }}<span *ngIf="selectedProjectName && selectedClientName"> - </span>{{ selectedClientName }})
        </span>
      </h3>
    </div>

    <div class="card table-card">
      <!-- Table Container without vertical scroll -->
      <div class="table-scroll-container">
        <table class="styled-table">
          <thead>
            <tr>
              <th class="col-sno">S. No.</th>
              <th class="col-test-case-id">Test Case ID</th>
              <th class="col-title">Title</th>
              <th class="col-page-name">Page Name</th>
              <th class="col-category">Category</th>
              <!-- ‚úÖ NEW: Requirement Column when showing all project test cases -->
              <th *ngIf="showAllProjectTestCases" class="col-requirement">Requirement</th>
              <th>Status</th>
              <th>Bug Status</th>
              <th class="col-boolean">Is Automated</th>
              <th class="col-boolean">Is Executed</th>
              <th class="col-boolean">Bug Raised</th>
              <th>Bug Screenshots</th>
              <th>Assigned To</th>
              <th>Executed By</th>
              <th class="col-datetime">Executed On</th>
              <th>Created By</th>
              <th class="col-datetime">Created At</th>
              <th class="actions-header">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let testCase of paginatedTestCases(); let i = index">
              <!-- Serial Number -->
              <td class="col-sno">{{ (currentPage - 1) * pageSize + i + 1 }}</td>
              
              <!-- Test Case ID - Now clickable -->
              <td class="col-test-case-id">
                <div class="clickable-text wrapped-text" 
                     (click)="navigateToTestCaseDetails(testCase)"
                     title="Click to view test case details">
                  {{ testCase.test_case_id || '-' }}
                </div>
              </td>
              
              <!-- Title with wrapping and clickable -->
              <td class="col-title">
                <div class="clickable-text wrapped-text"
                     (click)="navigateToTestCaseDetails(testCase)"
                     title="Click to view test case details">
                  {{ testCase.title }}
                </div>
              </td>

              <!-- Page Name with wrapping -->
              <td class="col-page-name">
                <div class="wrapped-text">{{ testCase.page_name || '-' }}</div>
              </td>

              <!-- Category with wrapping -->
              <td class="col-category">
                <div class="wrapped-text">{{ testCase.category || 'Functional' }}</div>
              </td>

              <!-- ‚úÖ NEW: Requirement Column when showing all project test cases -->
              <td *ngIf="showAllProjectTestCases" class="col-requirement">
                <div class="wrapped-text">{{ testCase.requirement_title || '-' }}</div>
              </td>

              <!-- Status -->
              <td>
                <span class="status-badge {{ testCase.status?.toLowerCase()?.replace(' ', '-') || 'pending' }}">
                  {{ testCase.status || 'Not tested yet' }}
                </span>
              </td>

              <!-- Bug Status -->
              <td>
                <span *ngIf="testCase.bug_status"
                      class="bug-status-badge {{ testCase.bug_status?.toLowerCase().replace(' ', '-') }}">
                  {{ testCase.bug_status }}
                </span>
                <span *ngIf="!testCase.bug_status">-</span>
              </td>

              <!-- Is Automated -->
              <td class="col-boolean">
                <span [ngClass]="testCase.is_automated ? 'icon-yes' : 'icon-no'">
                  {{ testCase.is_automated ? '‚úî' : '‚úñ' }}
                </span>
              </td>

              <!-- Is Executed -->
              <td class="col-boolean">
                <span [ngClass]="testCase.is_executed ? 'icon-yes' : 'icon-no'">
                  {{ testCase.is_executed ? '‚úî' : '‚úñ' }}
                </span>
              </td>

              <!-- Bug Raised -->
              <td class="col-boolean">
                <span [ngClass]="testCase.bug_raised ? 'icon-yes' : 'icon-no'">
                  {{ testCase.bug_raised ? '‚úî' : '‚úñ' }}
                </span>
              </td>

              <!-- Bug Screenshots - Updated to show view link -->
              <td>
                <div *ngIf="testCase.bug_screenshots && testCase.bug_screenshots.length > 0" class="screenshots-link">
                  <button class="view-screenshots-btn" (click)="viewAllScreenshots(testCase)">
                    üì∑ View Screenshots ({{ testCase.bug_screenshots.length }})
                  </button>
                </div>
                <span *ngIf="!testCase.bug_screenshots || testCase.bug_screenshots.length === 0">-</span>
              </td>

              <!-- Assigned To with wrapping -->
              <td>{{ getDeveloperDisplay(testCase.assigned_to) }}</td>

              <!-- Executed By with wrapping -->
              <td>{{ getUsername(testCase.executed_by) }}</td>
              
              <!-- Executed On - NO WRAPPING -->
              <td class="col-datetime">{{ testCase.executed_on ? (testCase.executed_on | date:'medium') : '-' }}</td>
              
              <!-- Created By with wrapping -->
              <td>{{ getUsername(testCase.created_by) }}</td>
              
              <!-- Created At - NO WRAPPING -->
              <td class="col-datetime">{{ testCase.created_at ? (testCase.created_at | date:'medium') : '-' }}</td>

              <!-- Actions -->
              <td class="actions">
                <button class="edit-btn" (click)="editTestCase(testCase)" title="Edit Test Case">‚úèÔ∏è</button>
                <button class="execute-btn" (click)="executeTestCase(testCase)"
                        *ngIf="!testCase.is_executed" title="Execute Test Case">‚ñ∂Ô∏è</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      <div class="pagination-container" *ngIf="filteredTestCases.length > 0">
        <div class="pagination-summary">
          Showing {{ getStartIndex() }}-{{ getEndIndex() }} of {{ filteredTestCases.length }} records
        </div>
        <div class="pagination-controls">
          <button 
            class="pagination-btn" 
            [disabled]="currentPage === 1" 
            (click)="goToPage(currentPage - 1)">
            Previous
          </button>
          
          <button 
            *ngFor="let page of getVisiblePages()" 
            class="pagination-btn" 
            [class.active]="page === currentPage"
            (click)="goToPage(page)">
            {{ page }}
          </button>
          
          <button 
            class="pagination-btn" 
            [disabled]="currentPage === totalPages()" 
            (click)="goToPage(currentPage + 1)">
            Next
          </button>
        </div>
      </div>

      <!-- ‚úÖ UPDATED: No test cases message -->
      <div *ngIf="filteredTestCases.length === 0 && selectedProjectId" class="no-requirements">
        No test cases found 
        <span *ngIf="selectedRequirementId">for this requirement</span>
        <span *ngIf="selectedCategory"> for category: {{ selectedCategory }}</span>.
      </div>
    </div>
  </div>

  <!-- ‚úÖ UPDATED: Message when no project selected -->
  <div *ngIf="!selectedProjectId" class="placeholder-message card">
    <div class="message-content">
      <h3>Select Client and Project</h3>
      <p>Select a client and project from the dropdowns above to display the test cases.</p>
    </div>
  </div>

  <!-- Success Notification -->
  <div *ngIf="showSuccessMessage" class="success-notification">
    <span>{{ successMessage }}</span>
    <button class="close-notification" (click)="hideSuccessMessage()">√ó</button>
  </div>

  <!-- Error Notification -->
  <div *ngIf="showErrorMessage" class="error-notification">
    <span>{{ errorMessage }}</span>
    <button class="close-notification" (click)="hideErrorMessage()">√ó</button>
  </div>

  <!-- Import Test Cases Popup - UPDATED INSTRUCTIONS -->
  <div class="popup" *ngIf="showImportPopup">
    <div class="popup-content large-popup">
      <div class="popup-header">
        <h3>Import Test Cases</h3>
        <button class="close-btn" (click)="closeImportPopup()">‚úñ</button>
      </div>

      <div class="import-instructions">
        <h4>üìã IMPORTANT INSTRUCTIONS:</h4>
        <ul>
          <li><strong>Download the template first</strong> - it's pre-configured for the selected project</li>
          <li><strong>Project-specific template</strong> - This template is for: <strong>{{ selectedProjectName }}</strong></li>
          <li><strong>Do NOT modify Column A (project_id)</strong> - It's automatically set to the correct project</li>
          <li><strong>Column B (test_case_id)</strong> - Enter unique test case IDs for this project</li>
          <li><strong>Column C (requirement_id)</strong> - Select from dropdown (only shows requirements for this project)</li>
          <li><strong>Use dropdowns</strong> for all selection fields to avoid errors</li>
          <li><strong>Date format</strong>: YYYY-MM-DD (e.g., 2024-01-15)</li>
          <li><strong>Boolean fields</strong>: Use "True" or "False" (case-sensitive)</li>
          <li>Check the <strong>Instructions sheet</strong> in the template for detailed guidance</li>
        </ul>
      </div>

      <div class="file-upload-section">
        <div class="upload-area" 
             [class.active]="isDragOver"
             (drop)="onFileDrop($event)"
             (dragover)="onDragOver($event)"
             (dragleave)="onDragLeave($event)"
             (click)="fileInput.click()">
          <div class="upload-placeholder" *ngIf="!importFile">
            <span class="upload-icon">üìÅ</span>
            <p>Click to browse or drag and drop Excel file here</p>
            <small>Supports .xlsx, .xls files only (max 10MB)</small>
          </div>
          <div class="file-preview" *ngIf="importFile">
            <span class="file-icon">üìÑ</span>
            <div class="file-info">
              <strong>{{ importFile.name }}</strong>
              <small>Size: {{ getFileSize(importFile.size) }}</small>
            </div>
            <button type="button" class="remove-btn" (click)="removeImportFile($event)">‚úñ</button>
          </div>
        </div>
        <input #fileInput type="file" (change)="onImportFileSelected($event)" accept=".xlsx,.xls" hidden>
      </div>

      <!-- Validation Results - UPDATED FOR NEW API RESPONSE STRUCTURE -->
      <div *ngIf="importResults" class="validation-results">
        <div class="result-summary" 
             [class.success]="importResults.success && importResults.imported > 0"
             [class.warning]="!importResults.success || importResults.errors?.length > 0">
          <strong *ngIf="importResults.success && importResults.imported > 0">
            ‚úÖ Successfully imported {{ importResults.imported }} test cases!
          </strong>
          <strong *ngIf="!importResults.success" class="error-text">
            ‚ùå Import failed: {{ importResults.message }}
          </strong>
          <strong *ngIf="importResults.success && importResults.imported === 0" class="warning-text">
            ‚ö†Ô∏è {{ importResults.message }}
          </strong>
        </div>

        <!-- Errors List -->
        <div *ngIf="importResults.errors && importResults.errors.length > 0" class="error-details">
          <h5>‚ùå Errors ({{ importResults.errors.length }}):</h5>
          <div class="errors-list">
            <div *ngFor="let error of importResults.errors" class="error-item">
              <strong>{{ error }}</strong>
            </div>
          </div>
        </div>

        <!-- Skipped Records -->
        <div *ngIf="importResults.skipped && importResults.skipped.length > 0" class="skipped-details">
          <h5>‚ö†Ô∏è Skipped Records ({{ importResults.skipped.length }}):</h5>
          <div class="skipped-list">
            <div *ngFor="let skipped of importResults.skipped" class="skipped-item">
              {{ skipped }}
            </div>
          </div>
        </div>

        <!-- Success Details -->
        <div *ngIf="importResults.success && importResults.imported > 0" class="success-details">
          <h5>‚úÖ Import Summary:</h5>
          <div class="success-stats">
            <p><strong>Total Rows Processed:</strong> {{ importResults.total_rows }}</p>
            <p><strong>Successfully Imported:</strong> {{ importResults.imported }}</p>
            <p *ngIf="importResults.errors?.length > 0"><strong>Errors:</strong> {{ importResults.errors.length }}</p>
            <p *ngIf="importResults.skipped?.length > 0"><strong>Skipped:</strong> {{ importResults.skipped.length }}</p>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="save-btn" (click)="confirmImport()" 
                [disabled]="!importFile || isImporting">
          {{ isImporting ? '‚è≥ Importing...' : 'üöÄ Import Test Cases' }}
        </button>
        <button type="button" class="cancel-btn" (click)="closeImportPopup()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Confirmation Popup for Import - UPDATED -->
  <div class="popup" *ngIf="showImportConfirmation">
    <div class="popup-content medium-popup">
      <div class="popup-header">
        <h3>Confirm Import</h3>
        <button class="close-btn" (click)="closeImportConfirmation()">‚úñ</button>
      </div>

      <div class="confirmation-content">
        <div *ngIf="importResults?.success_count > 0" class="import-success">
          <p>‚úÖ <strong>{{ importResults.success_count }}</strong> test cases are ready to import.</p>
        </div>
        
        <div *ngIf="importResults?.error_count > 0" class="import-warnings">
          <p>‚ö†Ô∏è <strong>{{ importResults.error_count }}</strong> rows have errors and will be skipped.</p>
          
          <div class="error-preview" *ngIf="importResults.errors && importResults.errors.length > 0">
            <h5>Sample Errors:</h5>
            <div *ngFor="let error of importResults.errors.slice(0, 3)" class="error-preview-item">
              {{ error }}
            </div>
            <div *ngIf="importResults.errors.length > 3" class="more-errors">
              ... and {{ importResults.errors.length - 3 }} more errors
            </div>
          </div>
        </div>

        <p class="confirmation-question">Do you want to proceed with the import?</p>
      </div>

      <div class="form-actions">
        <button type="button" class="save-btn" (click)="proceedWithImport()">
          Yes, Import {{ importResults?.success_count || 0 }} Test Cases
        </button>
        <button type="button" class="cancel-btn" (click)="closeImportConfirmation()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Add/Edit Test Case Popup -->
  <div class="popup" *ngIf="showTestCasePopup">
    <div class="popup-content large-popup">
      <div class="popup-header">
        <h3>{{ isEditMode ? 'Edit Test Case' : 'Add Test Case' }}</h3>
        <button class="close-btn" (click)="closeTestCasePopup()">‚úñ</button>
      </div>

      <form (ngSubmit)="saveTestCase()" class="form-grid" enctype="multipart/form-data">
        <!-- Test Case ID - First Field -->
        <label>Test Case ID *</label>
        <input type="text" [(ngModel)]="newTestCase.test_case_id" name="test_case_id" 
               [class.error]="formErrors.test_case_id" required 
               placeholder="Enter test case ID (e.g., TC_001)" />
        <div *ngIf="formErrors.test_case_id" class="error-message">{{ formErrors.test_case_id }}</div>

        <label>Title *</label>
        <input type="text" [(ngModel)]="newTestCase.title" name="title" 
               [class.error]="formErrors.title" required 
               placeholder="Enter test case title" />
        <div *ngIf="formErrors.title" class="error-message">{{ formErrors.title }}</div>

        <!-- ‚úÖ CRITICAL FIX: Page Name field with proper binding -->
        <label>Page Name *</label>
        <input type="text" [(ngModel)]="newTestCase.page_name" name="page_name" 
               [class.error]="formErrors.page_name" required 
               placeholder="Enter page name (e.g., Login, Dashboard, Profile)" />
        <div *ngIf="formErrors.page_name" class="error-message">{{ formErrors.page_name }}</div>

         <!-- ‚úÖ ADDED: Category Field -->
        <label>Category *</label>
        <select [(ngModel)]="newTestCase.category" name="category" 
                [class.error]="formErrors.category" required>
          <option value="Functional">Functional</option>
          <option value="UI">UI</option>
          <option value="Performance">Performance</option>
          <option value="Security">Security</option>
          <option value="Integration">Integration</option>
          <option value="Regression">Regression</option>
        </select>
        <div *ngIf="formErrors.category" class="error-message">{{ formErrors.category }}</div>

        <label>Description *</label>
        <textarea [(ngModel)]="newTestCase.description" name="description" rows="3" 
                  [class.error]="formErrors.description" required
                  placeholder="Describe the test scenario"></textarea>
        <div *ngIf="formErrors.description" class="error-message">{{ formErrors.description }}</div>

        <label>Pre Conditions</label>
        <textarea [(ngModel)]="newTestCase.pre_conditions" name="pre_conditions" rows="2"
        placeholder="Any prerequisites or setup required"></textarea>

        <label>Expected Result *</label>
        <textarea [(ngModel)]="newTestCase.expected_result" name="expected_result" rows="3" 
                  [class.error]="formErrors.expected_result" required
                  placeholder="What is the expected outcome?"></textarea>
        <div *ngIf="formErrors.expected_result" class="error-message">{{ formErrors.expected_result }}</div>

        <label>Actual Result</label>
        <textarea [(ngModel)]="newTestCase.actual_result" name="actual_result" rows="3"
        placeholder="What actually happened during execution?"></textarea>

        <!-- Is Executed -->
        <label class="checkbox-field">
          <input type="checkbox" [(ngModel)]="newTestCase.is_executed" name="is_executed" />
          Is Executed
        </label>

        <!-- Show Test Actions, Execution Date & Status only if executed -->
        <ng-container *ngIf="newTestCase.is_executed">
          <label>Test Actions *</label>
          <textarea [(ngModel)]="newTestCase.test_actions" name="test_actions" rows="3" 
                    [class.error]="formErrors.test_actions" required
                    placeholder="Step-by-step actions to perform the test"></textarea>
          <div *ngIf="formErrors.test_actions" class="error-message">{{ formErrors.test_actions }}</div>

          <label>Executed On</label>
          <input type="datetime-local" [(ngModel)]="newTestCase.executed_on" name="executed_on" 
                class="form-control" />

          <label>Status</label>
          <select [(ngModel)]="newTestCase.status" name="status">
            <option value="Pass">Pass</option>
            <option value="Fail">Fail</option>
            <option value="Not tested yet">Not tested yet</option>
          </select>
        </ng-container>

        <!-- Bug Raised -->
        <label class="checkbox-field">
          <input type="checkbox" [(ngModel)]="newTestCase.bug_raised" name="bug_raised" />
          Bug Raised
        </label>

        <!-- Show bug fields only if bug raised -->
        <ng-container *ngIf="newTestCase.bug_raised">
          <!-- Multiple Screenshots Upload Section -->
          <label>Bug Screenshots</label>
          <div class="screenshots-upload-section">
            <!-- File upload option for multiple files -->
            <div class="file-upload-option">
              <input type="file" 
                     (change)="onMultipleScreenshotsSelected($event)" 
                     accept="image/*" 
                     multiple />
              <small>Select multiple screenshots (PNG, JPEG, JPG, GIF - max 5MB each)</small>
            </div>
            
            <!-- Clipboard paste option for multiple images -->
            <div class="clipboard-upload-option">
              <div class="clipboard-area" 
                   [class.active]="isClipboardActive"
                   (click)="activateClipboard()"
                   (paste)="onPasteMultipleScreenshots($event)"
                   tabindex="0">
                <div class="clipboard-placeholder" *ngIf="uploadedScreenshots.length === 0">
                  <span class="clipboard-icon">üìã</span>
                  <p>Click here and press Ctrl+V to paste screenshots</p>
                  <small>You can paste multiple screenshots one by one</small>
                </div>
                <div class="clipboard-preview" *ngIf="uploadedScreenshots.length > 0">
                  <div class="screenshots-grid">
                    <div *ngFor="let screenshot of uploadedScreenshots; let i = index" class="screenshot-item">
                      <img [src]="screenshot.preview" [alt]="'Screenshot ' + (i + 1)" class="pasted-screenshot">
                      <button type="button" class="remove-btn" (click)="removeUploadedScreenshot(i)">‚úñ</button>
                    </div>
                  </div>
                  <p class="screenshot-count">{{ uploadedScreenshots.length }} screenshot(s) ready to upload</p>
                </div>
              </div>
            </div>

            <!-- ‚úÖ UPDATED: Existing screenshots preview for edit mode -->
            <div class="existing-screenshots" *ngIf="isEditMode && existingScreenshots.length > 0">
              <h4>Existing Screenshots ({{ existingScreenshots.length }})</h4>
              <div class="screenshots-grid">
                <div *ngFor="let screenshot of existingScreenshots; let i = index" class="screenshot-item">
                  <img [src]="screenshot.screenshot_url" 
                       [alt]="screenshot.caption || 'Screenshot ' + (i + 1)" 
                       class="existing-screenshot"
                       (click)="viewScreenshot(screenshot.screenshot_url)">
                  <div class="screenshot-actions">
                    <button type="button" class="view-btn" (click)="viewScreenshot(screenshot.screenshot_url)">üëÅÔ∏è</button>
                    <button type="button" class="remove-btn" (click)="removeExistingScreenshot(screenshot.id)">‚úñ</button>
                  </div>
                </div>
              </div>
              <p class="screenshot-note">Click on any screenshot to view in full size</p>
            </div>

            <!-- ‚úÖ ADDED: No existing screenshots message -->
            <div class="no-screenshots" *ngIf="isEditMode && existingScreenshots.length === 0">
              <p>No existing screenshots found for this test case.</p>
            </div>
          </div>

          <label>Bug Status *</label>
          <select [(ngModel)]="newTestCase.bug_status" name="bug_status" 
                  [class.error]="formErrors.bug_status" required>
            <option value="">Select Bug Status</option>
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Resolved">Resolved</option>
            <option value="Closed">Closed</option>
          </select>
          <div *ngIf="formErrors.bug_status" class="error-message">{{ formErrors.bug_status }}</div>
        </ng-container>

        <!-- Assigned To -->
        <label>Assigned To</label>
        <select [(ngModel)]="newTestCase.assigned_to" name="assigned_to" class="form-control">
          <option [value]="null">-- Select Developer --</option>
          <option *ngFor="let developer of projectDevelopers" [value]="developer.id">
            {{ developer.name }} ({{ developer.role }})
          </option>
        </select>

        <!-- Test Data -->
        <label>Test Data</label>
        <div class="test-data-section">
          <select [(ngModel)]="newTestCase.test_data" name="test_data" class="test-data-select">
            <option [value]="null">-- Select Test Data --</option>
            <option *ngFor="let testData of testDataList" [value]="testData.id">
              {{ getTestDataDisplay(testData) }}
            </option>
          </select>
          <button type="button" class="add-test-data-btn" (click)="openAddTestDataPopup()">+ Add Test Data</button>
        </div>

        <!-- Is Automated -->
        <label class="checkbox-field">
          <input type="checkbox" [(ngModel)]="newTestCase.is_automated" name="is_automated" />
          Is Automated
        </label>

        <!-- Comments -->
        <label>Comments</label>
        <textarea [(ngModel)]="newTestCase.comments" name="comments" rows="2"
        placeholder="Additional notes or comments"></textarea>

        <div class="form-actions">
          <button type="submit" class="save-btn">{{ isEditMode ? 'Update' : 'Save' }}</button>
          <button type="button" class="cancel-btn" (click)="closeTestCasePopup()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Multiple Screenshots Viewer Popup -->
  <div class="popup" *ngIf="showScreenshotsViewer">
    <div class="popup-content image-viewer-large">
      <div class="popup-header">
        <h3>Bug Screenshots ({{ currentScreenshotIndex + 1 }}/{{ viewingScreenshots.length }})</h3>
        <button class="close-btn" (click)="closeScreenshotsViewer()">‚úñ</button>
      </div>
      <div class="image-navigation">
        <button class="nav-btn prev-btn" (click)="previousScreenshot()" [disabled]="currentScreenshotIndex === 0">‚Äπ</button>
        <div class="image-container">
          <img [src]="viewingScreenshots[currentScreenshotIndex]" 
               alt="Bug Screenshot" 
               class="full-screenshot">
        </div>
        <button class="nav-btn next-btn" (click)="nextScreenshot()" [disabled]="currentScreenshotIndex === viewingScreenshots.length - 1">‚Ä∫</button>
      </div>
      <div class="screenshot-thumbnails">
        <div *ngFor="let screenshot of viewingScreenshots; let i = index" 
             class="thumbnail" 
             [class.active]="i === currentScreenshotIndex"
             (click)="goToScreenshot(i)">
          <img [src]="screenshot" [alt]="'Thumbnail ' + (i + 1)">
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Test Data Popup -->
  <div class="popup" *ngIf="showTestDataPopup">
    <div class="popup-content medium-popup">
      <div class="popup-header">
        <h3>{{ isEditTestDataMode ? 'Edit Test Data' : 'Add Test Data' }}</h3>
        <button class="close-btn" (click)="closeTestDataPopup()">‚úñ</button>
      </div>

      <!-- General error message for test data form -->
      <div *ngIf="formTestDataErrors.general" class="error-message general-error">
        {{ formTestDataErrors.general }}
      </div>

      <form (ngSubmit)="saveTestData()" class="form-grid" enctype="multipart/form-data">
        <label>Data Type *</label>
        <select [(ngModel)]="newTestData.data_type" name="data_type" 
                [class.error]="formTestDataErrors.data_type" required (change)="onDataTypeChange()">
          <option value="">Select Data Type</option>
          <option value="text">Text</option>
          <option value="file">File</option>
          <option value="image">Image</option>
          <option value="other">Other</option>
        </select>
        <div *ngIf="formTestDataErrors.data_type" class="error-message">{{ formTestDataErrors.data_type }}</div>

        <div *ngIf="newTestData.data_type === 'text'">
          <label>Text Data *</label>
          <textarea [(ngModel)]="newTestData.text_data" name="text_data" rows="4" 
                    [class.error]="formTestDataErrors.text_data" required></textarea>
          <div *ngIf="formTestDataErrors.text_data" class="error-message">{{ formTestDataErrors.text_data }}</div>
        </div>

        <div *ngIf="newTestData.data_type === 'file'">
          <label>File Data *</label>
          <input type="file" (change)="onTestDataFileSelected($event, 'file')" accept="*/*" 
                 [class.error]="formTestDataErrors.file_data" required />
          <span *ngIf="newTestData.file_data_name" class="file-name">{{ newTestData.file_data_name }}</span>
          <div *ngIf="formTestDataErrors.file_data" class="error-message">{{ formTestDataErrors.file_data }}</div>
        </div>

        <div *ngIf="newTestData.data_type === 'image'">
          <label>Image Data *</label>
          <input type="file" (change)="onTestDataFileSelected($event, 'image')" accept="image/*" 
                 [class.error]="formTestDataErrors.image_data" required />
          <span *ngIf="newTestData.image_data_name" class="file-name">{{ newTestData.image_data_name }}</span>
          <div *ngIf="formTestDataErrors.image_data" class="error-message">{{ formTestDataErrors.image_data }}</div>
        </div>

        <div *ngIf="newTestData.data_type === 'other'">
          <label>Other Data</label>
          <textarea [(ngModel)]="newTestData.text_data" name="text_data" rows="4"></textarea>
        </div>

        <div class="form-actions">
          <button type="submit" class="save-btn">{{ isEditTestDataMode ? 'Update' : 'Save' }}</button>
          <button type="button" class="cancel-btn" (click)="closeTestDataPopup()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Execute Test Case Popup -->
  <div class="popup" *ngIf="showExecutePopup">
    <div class="popup-content medium-popup">
      <div class="popup-header">
        <h3>Execute Test Case: {{ executingTestCase?.test_case_id }} - {{ executingTestCase?.title }}</h3>
        <button class="close-btn" (click)="closeExecutePopup()">‚úñ</button>
      </div>

      <form (ngSubmit)="saveExecution()" class="form-grid">
        <label>Status *</label>
        <select [(ngModel)]="executionData.status" name="status" 
                [class.error]="formExecutionErrors.status" required>
          <option value="">Select Status</option>
          <option value="Pass">Pass</option>
          <option value="Fail">Fail</option>
        </select>
        <div *ngIf="formExecutionErrors.status" class="error-message">{{ formExecutionErrors.status }}</div>

        <label>Actual Result</label>
        <textarea [(ngModel)]="executionData.actual_result" name="actual_result" rows="3"></textarea>

        <label>Comments</label>
        <textarea [(ngModel)]="executionData.comments" name="comments" rows="2"></textarea>

        <label class="checkbox-field">
          <input type="checkbox" [(ngModel)]="executionData.bug_raised" name="bug_raised" />
          Bug Raised
        </label>

        <ng-container *ngIf="executionData.bug_raised">
          <label>Bug Status *</label>
          <select [(ngModel)]="executionData.bug_status" name="bug_status" 
                  [class.error]="formExecutionErrors.bug_status" required>
            <option value="">Select Bug Status</option>
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Resolved">Resolved</option>
            <option value="Closed">Closed</option>
          </select>
          <div *ngIf="formExecutionErrors.bug_status" class="error-message">{{ formExecutionErrors.bug_status }}</div>
        </ng-container>

        <div class="form-actions">
          <button type="submit" class="save-btn">Save Execution</button>
          <button type="button" class="cancel-btn" (click)="closeExecutePopup()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>