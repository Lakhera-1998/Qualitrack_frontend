<div class="testcases-container">
  <div class="header">
    <h2>Test Cases</h2>
    <button class="add-btn" (click)="openAddTestCasePopup()" [disabled]="!selectedRequirementId">+ Add Test Case</button>
  </div>

  <!-- Client, Project, and Requirement Filters -->
  <div class="filters-card card">
    <h3>Filter Test Cases</h3>
    <div class="filter-form">
      <div class="form-group">
        <label for="clientSelect">Client *</label>
        <select id="clientSelect" [(ngModel)]="selectedClientId" (change)="onClientChange()" class="form-control">
          <option value="">Select Client</option>
          <option *ngFor="let client of clients" [value]="client.id">{{ client.client_name }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="projectSelect">Project *</label>
        <select id="projectSelect" [(ngModel)]="selectedProjectId" (change)="onProjectChange()" class="form-control" [disabled]="!selectedClientId">
          <option value="">Select Project</option>
          <option *ngFor="let project of filteredProjects" [value]="project.id">{{ project.project_name }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="requirementSelect">Requirement *</label>
        <select id="requirementSelect" [(ngModel)]="selectedRequirementId" (change)="onRequirementChange()" class="form-control" [disabled]="!selectedProjectId">
          <option value="">Select Requirement</option>
          <option *ngFor="let requirement of filteredRequirements" [value]="requirement.id">{{ requirement.requirement_title }}</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Test Cases Display Area -->
  <div *ngIf="selectedRequirementId && requirement" class="requirements-content">
    <div class="project-header">
      <h3>Test Cases for {{ requirement?.requirement_title }} ({{ selectedProjectName }} - {{ selectedClientName }})</h3>
    </div>

    <div class="card">
      <div class="table-container">
        <table class="styled-table">
          <thead>
            <tr>
              <th class="col-sno">S. No.</th>
              <th class="col-title">Title</th>
              <th>Status</th>
              <th>Bug Status</th>
              <th class="col-boolean">Is Automated</th>
              <th class="col-boolean">Is Executed</th>
              <th class="col-boolean">Bug Raised</th>
              <th>Assigned To</th>
              <th>Executed By</th>
              <th>Executed On</th>
              <th>Created By</th>
              <th>Created At</th>
              <th class="actions-header">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let testCase of testCases; let i = index">
              <!-- Serial Number -->
              <td class="col-sno">{{ i + 1 }}</td>
              
              <td class="col-title">{{ testCase.title }}</td>

              <td>
                <span class="status-badge {{ testCase.status?.toLowerCase()?.replace(' ', '-') || 'pending' }}">
                  {{ testCase.status || 'Not tested yet' }}
                </span>
              </td>

              <td>
                <span *ngIf="testCase.bug_status"
                      class="bug-status-badge {{ testCase.bug_status?.toLowerCase().replace(' ', '-') }}">
                  {{ testCase.bug_status }}
                </span>
                <span *ngIf="!testCase.bug_status">-</span>
              </td>

              <td class="col-boolean">
                <span [ngClass]="testCase.is_automated ? 'icon-yes' : 'icon-no'">
                  {{ testCase.is_automated ? '✔' : '✖' }}
                </span>
              </td>

              <td class="col-boolean">
                <span [ngClass]="testCase.is_executed ? 'icon-yes' : 'icon-no'">
                  {{ testCase.is_executed ? '✔' : '✖' }}
                </span>
              </td>

              <td class="col-boolean">
                <span [ngClass]="testCase.bug_raised ? 'icon-yes' : 'icon-no'">
                  {{ testCase.bug_raised ? '✔' : '✖' }}
                </span>
              </td>

              <td>{{ getDeveloperDisplay(testCase.assigned_to) }}</td>

              <td>{{ getUsername(testCase.executed_by) }}</td>
              <td>{{ testCase.executed_on ? (testCase.executed_on | date:'medium') : '-' }}</td>
              <td>{{ getUsername(testCase.created_by) }}</td>
              <td>{{ testCase.created_at ? (testCase.created_at | date:'medium') : '-' }}</td>

              <td class="actions">
                <button class="edit-btn" (click)="editTestCase(testCase)" title="Edit Test Case">✏️</button>
                <button class="execute-btn" (click)="executeTestCase(testCase)"
                        *ngIf="!testCase.is_executed" title="Execute Test Case">▶️</button>
              </td>
            </tr>
          </tbody>
        </table>
        
        <div *ngIf="testCases.length === 0 && selectedRequirementId" class="no-requirements">
          No test cases found for this requirement.
        </div>
      </div>
    </div>
  </div>

  <!-- Message when no client/project/requirement selected -->
  <div *ngIf="!selectedRequirementId" class="placeholder-message card">
    <div class="message-content">
      <h3>Select Client, Project and Requirement</h3>
      <p>Select a client, project and requirement from the dropdowns above to display the test cases.</p>
    </div>
  </div>

  <!-- Success Notification -->
  <div *ngIf="showSuccessMessage" class="success-notification">
    <span>{{ successMessage }}</span>
    <button class="close-notification" (click)="hideSuccessMessage()">×</button>
  </div>

  <!-- Add/Edit Test Case Popup -->
  <div class="popup" *ngIf="showTestCasePopup">
    <div class="popup-content large-popup">
      <div class="popup-header">
        <h3>{{ isEditMode ? 'Edit Test Case' : 'Add Test Case' }}</h3>
        <button class="close-btn" (click)="closeTestCasePopup()">✖</button>
      </div>

      <form (ngSubmit)="saveTestCase()" class="form-grid" enctype="multipart/form-data">
        <label>Title *</label>
        <input type="text" [(ngModel)]="newTestCase.title" name="title" 
               [class.error]="formErrors.title" required />
        <div *ngIf="formErrors.title" class="error-message">{{ formErrors.title }}</div>

        <label>Description *</label>
        <textarea [(ngModel)]="newTestCase.description" name="description" rows="3" 
                  [class.error]="formErrors.description" required></textarea>
        <div *ngIf="formErrors.description" class="error-message">{{ formErrors.description }}</div>

        <label>Pre Conditions</label>
        <textarea [(ngModel)]="newTestCase.pre_conditions" name="pre_conditions" rows="2"></textarea>

        <label>Expected Result *</label>
        <textarea [(ngModel)]="newTestCase.expected_result" name="expected_result" rows="3" 
                  [class.error]="formErrors.expected_result" required></textarea>
        <div *ngIf="formErrors.expected_result" class="error-message">{{ formErrors.expected_result }}</div>

        <label>Actual Result</label>
        <textarea [(ngModel)]="newTestCase.actual_result" name="actual_result" rows="3"></textarea>

        <!-- Is Executed -->
        <label class="checkbox-field">
          <input type="checkbox" [(ngModel)]="newTestCase.is_executed" name="is_executed" />
          Is Executed
        </label>

        <!-- Show Test Actions, Execution Date & Status only if executed -->
        <ng-container *ngIf="newTestCase.is_executed">
          <label>Test Actions *</label>
          <textarea [(ngModel)]="newTestCase.test_actions" name="test_actions" rows="3" 
                    [class.error]="formErrors.test_actions" required></textarea>
          <div *ngIf="formErrors.test_actions" class="error-message">{{ formErrors.test_actions }}</div>

          <label>Executed On</label>
          <input type="datetime-local" [(ngModel)]="newTestCase.executed_on" name="executed_on" 
                class="form-control" />

          <label>Status</label>
          <select [(ngModel)]="newTestCase.status" name="status">
            <option value="Pass">Pass</option>
            <option value="Fail">Fail</option>
            <option value="Not tested yet">Not tested yet</option>
          </select>
        </ng-container>

        <!-- Bug Raised -->
        <label class="checkbox-field">
          <input type="checkbox" [(ngModel)]="newTestCase.bug_raised" name="bug_raised" />
          Bug Raised
        </label>

        <!-- Show bug fields only if bug raised -->
        <ng-container *ngIf="newTestCase.bug_raised">
          <label>Bug Screenshot</label>
          <input type="file" (change)="onFileSelected($event, 'bug_screenshot')" accept="image/*" />

          <label>Bug Status *</label>
          <select [(ngModel)]="newTestCase.bug_status" name="bug_status" 
                  [class.error]="formErrors.bug_status" required>
            <option value="">Select Bug Status</option>
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Resolved">Resolved</option>
            <option value="Closed">Closed</option>
          </select>
          <div *ngIf="formErrors.bug_status" class="error-message">{{ formErrors.bug_status }}</div>
        </ng-container>

        <!-- Assigned To -->
        <label>Assigned To</label>
        <select [(ngModel)]="newTestCase.assigned_to" name="assigned_to" class="form-control">
          <option [value]="null">-- Select Developer --</option>
          <option *ngFor="let developer of projectDevelopers" [value]="developer.id">
            {{ developer.name }} ({{ developer.role }})
          </option>
        </select>

        <!-- Test Data -->
        <label>Test Data</label>
        <div class="test-data-section">
          <select [(ngModel)]="newTestCase.test_data" name="test_data" class="test-data-select">
            <option [value]="null">-- Select Test Data --</option>
            <option *ngFor="let testData of testDataList" [value]="testData.id">
              {{ getTestDataDisplay(testData) }}
            </option>
          </select>
          <button type="button" class="add-test-data-btn" (click)="openAddTestDataPopup()">+ Add Test Data</button>
        </div>

        <!-- Is Automated -->
        <label class="checkbox-field">
          <input type="checkbox" [(ngModel)]="newTestCase.is_automated" name="is_automated" />
          Is Automated
        </label>

        <!-- Comments -->
        <label>Comments</label>
        <textarea [(ngModel)]="newTestCase.comments" name="comments" rows="2"></textarea>

        <div class="form-actions">
          <button type="submit" class="save-btn">{{ isEditMode ? 'Update' : 'Save' }}</button>
          <button type="button" class="cancel-btn" (click)="closeTestCasePopup()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add/Edit Test Data Popup -->
  <div class="popup" *ngIf="showTestDataPopup">
    <div class="popup-content medium-popup">
      <div class="popup-header">
        <h3>{{ isEditTestDataMode ? 'Edit Test Data' : 'Add Test Data' }}</h3>
        <button class="close-btn" (click)="closeTestDataPopup()">✖</button>
      </div>

      <!-- General error message for test data form -->
      <div *ngIf="formTestDataErrors.general" class="error-message general-error">
        {{ formTestDataErrors.general }}
      </div>

      <form (ngSubmit)="saveTestData()" class="form-grid" enctype="multipart/form-data">
        <label>Data Type *</label>
        <select [(ngModel)]="newTestData.data_type" name="data_type" 
                [class.error]="formTestDataErrors.data_type" required (change)="onDataTypeChange()">
          <option value="">Select Data Type</option>
          <option value="text">Text</option>
          <option value="file">File</option>
          <option value="image">Image</option>
          <option value="other">Other</option>
        </select>
        <div *ngIf="formTestDataErrors.data_type" class="error-message">{{ formTestDataErrors.data_type }}</div>

        <div *ngIf="newTestData.data_type === 'text'">
          <label>Text Data *</label>
          <textarea [(ngModel)]="newTestData.text_data" name="text_data" rows="4" 
                    [class.error]="formTestDataErrors.text_data" required></textarea>
          <div *ngIf="formTestDataErrors.text_data" class="error-message">{{ formTestDataErrors.text_data }}</div>
        </div>

        <div *ngIf="newTestData.data_type === 'file'">
          <label>File Data *</label>
          <input type="file" (change)="onFileSelected($event, 'file')" accept="*/*" 
                 [class.error]="formTestDataErrors.file_data" required />
          <span *ngIf="newTestData.file_data_name" class="file-name">{{ newTestData.file_data_name }}</span>
          <div *ngIf="formTestDataErrors.file_data" class="error-message">{{ formTestDataErrors.file_data }}</div>
        </div>

        <div *ngIf="newTestData.data_type === 'image'">
          <label>Image Data *</label>
          <input type="file" (change)="onFileSelected($event, 'image')" accept="image/*" 
                 [class.error]="formTestDataErrors.image_data" required />
          <span *ngIf="newTestData.image_data_name" class="file-name">{{ newTestData.image_data_name }}</span>
          <div *ngIf="formTestDataErrors.image_data" class="error-message">{{ formTestDataErrors.image_data }}</div>
        </div>

        <div *ngIf="newTestData.data_type === 'other'">
          <label>Other Data</label>
          <textarea [(ngModel)]="newTestData.text_data" name="text_data" rows="4"></textarea>
        </div>

        <div class="form-actions">
          <button type="submit" class="save-btn">{{ isEditTestDataMode ? 'Update' : 'Save' }}</button>
          <button type="button" class="cancel-btn" (click)="closeTestDataPopup()">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Execute Test Case Popup -->
  <div class="popup" *ngIf="showExecutePopup">
    <div class="popup-content medium-popup">
      <div class="popup-header">
        <h3>Execute Test Case: {{ executingTestCase?.title }}</h3>
        <button class="close-btn" (click)="closeExecutePopup()">✖</button>
      </div>

      <form (ngSubmit)="saveExecution()" class="form-grid">
        <label>Status *</label>
        <select [(ngModel)]="executionData.status" name="status" 
                [class.error]="formExecutionErrors.status" required>
          <option value="">Select Status</option>
          <option value="Pass">Pass</option>
          <option value="Fail">Fail</option>
        </select>
        <div *ngIf="formExecutionErrors.status" class="error-message">{{ formExecutionErrors.status }}</div>

        <label>Actual Result</label>
        <textarea [(ngModel)]="executionData.actual_result" name="actual_result" rows="3"></textarea>

        <label>Comments</label>
        <textarea [(ngModel)]="executionData.comments" name="comments" rows="2"></textarea>

        <label class="checkbox-field">
          <input type="checkbox" [(ngModel)]="executionData.bug_raised" name="bug_raised" />
          Bug Raised
        </label>

        <ng-container *ngIf="executionData.bug_raised">
          <label>Bug Status *</label>
          <select [(ngModel)]="executionData.bug_status" name="bug_status" 
                  [class.error]="formExecutionErrors.bug_status" required>
            <option value="">Select Bug Status</option>
            <option value="Open">Open</option>
            <option value="In Progress">In Progress</option>
            <option value="Resolved">Resolved</option>
            <option value="Closed">Closed</option>
          </select>
          <div *ngIf="formExecutionErrors.bug_status" class="error-message">{{ formExecutionErrors.bug_status }}</div>
        </ng-container>

        <div class="form-actions">
          <button type="submit" class="save-btn">Save Execution</button>
          <button type="button" class="cancel-btn" (click)="closeExecutePopup()">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
