<div class="test-case-details-container">
  <div class="header">
    <button class="back-btn" (click)="goBack()">‚Üê Back to Test Cases</button>
    <h2>Test Case Details</h2>
    <!-- Edit button removed -->
  </div>

  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading test case details...</p>
  </div>

  <div *ngIf="error" class="error-container card">
    <h3>Error Loading Test Case</h3>
    <p>{{ error }}</p>
    <button class="retry-btn" (click)="loadTestCase()">Retry</button>
  </div>

  <div *ngIf="testCase && !loading" class="test-case-content">
    <!-- Header Section -->
    <div class="header-section card">
      <div class="test-case-header">
        <h1 class="test-case-id">{{ testCase.test_case_id }}</h1>
        <div class="status-badges">
          <span class="status-badge {{ testCase.status?.toLowerCase()?.replace(' ', '-') || 'pending' }}">
            {{ testCase.status || 'Not tested yet' }}
          </span>
          <span *ngIf="testCase.bug_status" 
                class="bug-status-badge {{ testCase.bug_status?.toLowerCase().replace(' ', '-') }}">
            {{ testCase.bug_status }}
          </span>
        </div>
      </div>
      <h2 class="test-case-title">{{ testCase.title }}</h2>
      <div class="meta-info">
        <div class="meta-item">
          <strong>Page:</strong> {{ testCase.page_name || '-' }}
        </div>
        <div class="meta-item">
          <strong>Created:</strong> {{ testCase.created_at | date:'medium' }} by {{ getUsername(testCase.created_by) }}
        </div>
        <div class="meta-item" *ngIf="testCase.assigned_to">
          <strong>Assigned To:</strong> {{ getDeveloperDisplay(testCase.assigned_to) }}
        </div>
        <div class="meta-item" *ngIf="testCase.updated_at">
          <strong>Last Updated:</strong> {{ testCase.updated_at | date:'medium' }}
        </div>
      </div>
    </div>

    <!-- Main Content Grid -->
    <div class="content-grid">
      <!-- Left Column -->
      <div class="left-column">
        <!-- Description Section -->
        <div class="section card">
          <h3>Description</h3>
          <div class="section-content">
            <p>{{ testCase.description }}</p>
          </div>
        </div>

        <!-- Pre Conditions Section -->
        <div class="section card" *ngIf="testCase.pre_conditions">
          <h3>Pre Conditions</h3>
          <div class="section-content">
            <p>{{ testCase.pre_conditions }}</p>
          </div>
        </div>

        <!-- Test Actions Section -->
        <div class="section card" *ngIf="testCase.test_actions">
          <h3>Test Actions</h3>
          <div class="section-content">
            <p>{{ testCase.test_actions }}</p>
          </div>
        </div>

        <!-- Expected Result Section -->
        <div class="section card">
          <h3>Expected Result</h3>
          <div class="section-content">
            <p>{{ testCase.expected_result }}</p>
          </div>
        </div>

        <!-- Comments Section -->
        <div class="section card" *ngIf="testCase.comments">
          <h3>Comments</h3>
          <div class="section-content">
            <div class="comments-content">
              <p>{{ testCase.comments }}</p>
            </div>
          </div>
        </div>

        <!-- Test Data Section -->
        <div class="section card" *ngIf="testData && testData.length > 0">
          <h3>Test Data ({{ testData.length }})</h3>
          <div class="test-data-list">
            <div *ngFor="let data of testData; let i = index" class="test-data-item">
              <div class="test-data-header">
                <div class="test-data-title">
                  <strong>#{{ i + 1 }} - {{ data.data_type | titlecase }} Data</strong>
                  <span class="data-id">ID: {{ data.id }}</span>
                </div>
                <span class="upload-date">
                  Uploaded: {{ data.uploaded_at | date:'medium' }}
                  <span *ngIf="data.uploaded_by">by {{ getUsername(data.uploaded_by) }}</span>
                </span>
              </div>
              
              <div class="test-data-content">
                <!-- Text Data -->
                <div *ngIf="data.data_type === 'text'" class="text-data-container">
                  <label>Text Content:</label>
                  <div class="text-data">{{ data.text_data }}</div>
                </div>

                <!-- File Data -->
                <div *ngIf="data.data_type === 'file'" class="file-data-container">
                  <label>File:</label>
                  <div class="file-info">
                    <a [href]="data.file_data" target="_blank" class="file-link" download>
                      üìé Download {{ data.file_data_name }}
                    </a>
                    <span class="file-size" *ngIf="data.file_size">({{ data.file_size }})</span>
                  </div>
                </div>

                <!-- Image Data -->
                <div *ngIf="data.data_type === 'image'" class="image-data-container">
                  <label>Image:</label>
                  <div class="image-info">
                    <div class="image-preview">
                      <img [src]="data.image_data" [alt]="data.image_data_name" 
                           (click)="viewImage(data.image_data)" class="test-data-image">
                      <div class="image-name">{{ data.image_data_name }}</div>
                    </div>
                    <button class="view-full-btn" (click)="viewImage(data.image_data)">View Full Size</button>
                  </div>
                </div>

                <!-- Other Data -->
                <div *ngIf="data.data_type === 'other'" class="other-data-container">
                  <label>Other Data:</label>
                  <div class="other-data">{{ data.text_data || 'No data available' }}</div>
                </div>

                <!-- Project Reference -->
                <div *ngIf="data.project" class="data-meta">
                  <small><strong>Project:</strong> {{ data.project?.project_name || 'N/A' }}</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- No Test Data Message -->
        <div class="section card" *ngIf="(!testData || testData.length === 0) && testCase.test_data">
          <h3>Test Data</h3>
          <div class="section-content">
            <div class="no-test-data">
              <p>No test data files associated with this test case.</p>
              <p class="test-data-reference" *ngIf="testCase.test_data">
                <strong>Referenced Test Data ID:</strong> {{ testCase.test_data }}
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column -->
      <div class="right-column">
        <!-- Execution Details -->
        <div class="section card" *ngIf="testCase.is_executed">
          <h3>Execution Details</h3>
          <div class="execution-details">
            <div class="detail-row">
              <label>Executed By:</label>
              <span>{{ getUsername(testCase.executed_by) }}</span>
            </div>
            <div class="detail-row">
              <label>Executed On:</label>
              <span>{{ testCase.executed_on | date:'medium' }}</span>
            </div>
            <div class="detail-row">
              <label>Actual Result:</label>
              <span class="actual-result">{{ testCase.actual_result || '-' }}</span>
            </div>
            <div class="detail-row" *ngIf="testCase.test_actions">
              <label>Test Actions:</label>
              <span class="test-actions">{{ testCase.test_actions }}</span>
            </div>
          </div>
        </div>

        <!-- Bug Information -->
        <div class="section card" *ngIf="testCase.bug_raised">
          <h3>Bug Information</h3>
          <div class="bug-details">
            <div class="detail-row">
              <label>Bug Status:</label>
              <span class="bug-status-badge {{ testCase.bug_status?.toLowerCase().replace(' ', '-') }}">
                {{ testCase.bug_status }}
              </span>
            </div>
            <div class="detail-row" *ngIf="testCase.bug_screenshot">
              <label>Bug Screenshot:</label>
              <div class="screenshot-container">
                <img [src]="testCase.bug_screenshot" 
                     alt="Bug Screenshot" 
                     (click)="viewImage(testCase.bug_screenshot)"
                     class="bug-screenshot">
                <button class="view-full-btn" (click)="viewImage(testCase.bug_screenshot)">View Full Size</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Additional Information -->
        <div class="section card">
          <h3>Additional Information</h3>
          <div class="additional-info">
            <div class="info-item">
              <label>Is Automated:</label>
              <span [ngClass]="testCase.is_automated ? 'icon-yes' : 'icon-no'">
                {{ testCase.is_automated ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="info-item">
              <label>Is Executed:</label>
              <span [ngClass]="testCase.is_executed ? 'icon-yes' : 'icon-no'">
                {{ testCase.is_executed ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="info-item">
              <label>Bug Raised:</label>
              <span [ngClass]="testCase.bug_raised ? 'icon-yes' : 'icon-no'">
                {{ testCase.bug_raised ? 'Yes' : 'No' }}
              </span>
            </div>
            <div class="info-item" *ngIf="testCase.test_data">
              <label>Test Data ID:</label>
              <span class="test-data-id">{{ testCase.test_data }}</span>
            </div>
          </div>
        </div>

        <!-- Project Information -->
        <div class="section card" *ngIf="testCase.project">
          <h3>Project Information</h3>
          <div class="project-info">
            <div class="detail-row">
              <label>Project ID:</label>
              <span>{{ testCase.project }}</span>
            </div>
            <div class="detail-row" *ngIf="testCase.requirement">
              <label>Requirement ID:</label>
              <span>{{ testCase.requirement }}</span>
            </div>
          </div>
        </div>

        <!-- System Information -->
        <div class="section card">
          <h3>System Information</h3>
          <div class="system-info">
            <div class="detail-row">
              <label>Created:</label>
              <span>{{ testCase.created_at | date:'medium' }}</span>
            </div>
            <div class="detail-row" *ngIf="testCase.updated_at">
              <label>Last Updated:</label>
              <span>{{ testCase.updated_at | date:'medium' }}</span>
            </div>
            <div class="detail-row">
              <label>Created By:</label>
              <span>{{ getUsername(testCase.created_by) }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Test Case History Section - Full Width -->
    <div class="history-section" *ngIf="testCaseHistory && testCaseHistory.length > 0">
      <div class="section card full-width">
        <h3>Update History ({{ testCaseHistory.length }})</h3>
        <div class="history-container">
          <div class="history-timeline">
            <div *ngFor="let history of testCaseHistory; let i = index" class="history-item">
              <div class="history-marker">
                <div class="history-dot"></div>
                <div class="history-line" *ngIf="i !== testCaseHistory.length - 1"></div>
              </div>
              <div class="history-content">
                <div class="history-header">
                  <div class="history-user">
                    <strong>{{ history.updated_by_name || 'System' }}</strong>
                    <span class="history-date">{{ history.updated_on | date:'medium' }}</span>
                  </div>
                  <div class="history-actions">
                    <span class="history-action">Updated Test Case</span>
                  </div>
                </div>
                
                <div class="history-details">
                  <!-- Bug Status Change -->
                  <div class="history-change" *ngIf="history.bug_status">
                    <label>Bug Status:</label>
                    <div class="change-content">
                      <span class="bug-status-badge {{ history.bug_status?.toLowerCase().replace(' ', '-') }}">
                        {{ history.bug_status }}
                      </span>
                    </div>
                  </div>

                  <!-- Test Status Change -->
                  <div class="history-change" *ngIf="history.status">
                    <label>Test Status:</label>
                    <div class="change-content">
                      <span class="status-badge {{ history.status?.toLowerCase()?.replace(' ', '-') || 'pending' }}">
                        {{ history.status }}
                      </span>
                    </div>
                  </div>

                  <!-- Comments -->
                  <div class="history-change" *ngIf="history.comment">
                    <label>Comments:</label>
                    <div class="change-content">
                      <div class="history-comment">
                        {{ history.comment }}
                      </div>
                    </div>
                  </div>

                  <!-- No changes message -->
                  <div class="history-change" *ngIf="!history.bug_status && !history.status && !history.comment">
                    <label>Update:</label>
                    <div class="change-content">
                      <span class="no-changes">No specific changes recorded</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- No History Message -->
    <div class="history-section" *ngIf="testCaseHistory && testCaseHistory.length === 0">
      <div class="section card full-width">
        <h3>Update History</h3>
        <div class="no-history">
          <p>No update history available for this test case.</p>
          <p class="no-history-sub">Updates will appear here when changes are made to bug status, test status, or comments.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Viewer Popup -->
  <div class="popup" *ngIf="showImagePopup">
    <div class="popup-content image-viewer">
      <div class="popup-header">
        <h3>Image Viewer</h3>
        <button class="close-btn" (click)="closeImagePopup()">‚úñ</button>
      </div>
      <div class="image-container">
        <img [src]="viewingImage" alt="Full size image" class="full-image">
      </div>
    </div>
  </div>
</div>