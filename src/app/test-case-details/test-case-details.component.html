<div class="test-case-details-container">
  <div class="header">
    <button class="back-btn" (click)="goBack()">‚Üê Back to Test Cases</button>
    <h2>Test Case Details</h2>
  </div>

  <div *ngIf="loading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading test case details...</p>
  </div>

  <div *ngIf="error" class="error-container card">
    <h3>Error Loading Test Case</h3>
    <p>{{ error }}</p>
    <button class="retry-btn" (click)="loadTestCase()">Retry</button>
  </div>

  <div *ngIf="testCase && !loading" class="test-case-content">
    <div class="header-section card">
      <div class="test-case-header">
        <h1 class="test-case-id">{{ testCase.test_case_id }}</h1>
        <div class="status-badges">
          <span class="status-badge {{ testCase.status?.toLowerCase()?.replace(' ', '-') || 'pending' }}">
            {{ testCase.status || 'Not tested yet' }}
          </span>

          <span *ngIf="testCase.bug_status"
                class="bug-status-badge {{ testCase.bug_status?.toLowerCase().replace(' ', '-') }}">
            {{ testCase.bug_status }}
          </span>
        </div>
      </div>

      <h2 class="test-case-title">{{ testCase.title }}</h2>

      <div class="meta-info">
        <div class="meta-item">
          <strong>Page:</strong> {{ testCase.page_name || '-' }}
        </div>
        <div class="meta-item">
          <strong>Created:</strong> {{ testCase.created_at | date:'medium' }} by {{ getUserDisplayName(testCase.created_by) }}
        </div>
        <div class="meta-item" *ngIf="testCase.assigned_to">
          <strong>Assigned To:</strong> {{ getUserDisplayName(testCase.assigned_to) }}
        </div>
        <div class="meta-item" *ngIf="testCase.updated_at">
          <strong>Last Updated:</strong> {{ testCase.updated_at | date:'medium' }}
        </div>
      </div>
    </div>

    <!-- GRID -->
    <div class="content-grid">
      <div class="left-column">
        <!-- BASIC DETAILS -->
        <div class="section card">
          <h3>Test Case Information</h3>

          <div class="details-grid">
            <div class="detail-item">
              <label>Description</label>
              <div class="detail-value">
                <p>{{ testCase.description }}</p>
              </div>
            </div>

            <div class="detail-item" *ngIf="testCase.pre_conditions">
              <label>Pre Conditions</label>
              <div class="detail-value">
                <p>{{ testCase.pre_conditions }}</p>
              </div>
            </div>

            <div class="detail-item" *ngIf="testCase.test_actions">
              <label>Test Actions</label>
              <div class="detail-value">
                <p>{{ testCase.test_actions }}</p>
              </div>
            </div>

            <div class="detail-item">
              <label>Expected Result</label>
              <div class="detail-value">
                <p>{{ testCase.expected_result }}</p>
              </div>
            </div>

            <div class="detail-item">
              <label>Additional Information</label>
              <div class="additional-info-grid">
                <div class="info-item">
                  <span class="info-label">Is Automated:</span>
                  <span [ngClass]="testCase.is_automated ? 'icon-yes' : 'icon-no'">
                    {{ testCase.is_automated ? 'Yes' : 'No' }}
                  </span>
                </div>

                <div class="info-item">
                  <span class="info-label">Is Executed:</span>
                  <span [ngClass]="testCase.is_executed ? 'icon-yes' : 'icon-no'">
                    {{ testCase.is_executed ? 'Yes' : 'No' }}
                  </span>
                </div>

                <div class="info-item">
                  <span class="info-label">Bug Raised:</span>
                  <span [ngClass]="testCase.bug_raised ? 'icon-yes' : 'icon-no'">
                    {{ testCase.bug_raised ? 'Yes' : 'No' }}
                  </span>
                </div>
              </div>
            </div>

            <div class="detail-item" *ngIf="testCase.project">
              <label>Project Information</label>
              <div class="project-info-grid">
                <div class="project-item">
                  <span class="project-label">Project:</span>
                  <span class="project-value">{{ getProjectNameForTestCase() }}</span>
                </div>

                <div class="project-item" *ngIf="testCase.requirement">
                  <span class="project-label">Requirement:</span>
                  <span class="project-value">{{ getRequirementTitle() }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- TEST DATA -->
        <div class="section card" *ngIf="testData && testData.length > 0">
          <h3>Test Data ({{ testData.length }})</h3>

          <div class="test-data-list">
            <div *ngFor="let data of testData; let i = index" class="test-data-item">
              <div class="test-data-header">
                <div class="test-data-title">
                  <strong>#{{ i + 1 }} - {{ data.data_type | titlecase }} Data</strong>
                  <span class="data-id">ID: {{ data.id }}</span>
                </div>

                <span class="upload-date">
                  Uploaded: {{ data.uploaded_at | date:'medium' }}
                  <span *ngIf="data.uploaded_by">by {{ getUserDisplayName(data.uploaded_by) }}</span>
                </span>
              </div>

              <div class="test-data-content">
                <div *ngIf="data.data_type === 'text'" class="text-data-container">
                  <label>Text Content:</label>
                  <div class="text-data">{{ data.text_data }}</div>
                </div>

                <div *ngIf="data.data_type === 'file'" class="file-data-container">
                  <label>File:</label>
                  <div class="file-info">
                    <a [href]="data.file_data" target="_blank" class="file-link" download>
                      üìé Download {{ data.file_data_name }}
                    </a>
                    <span class="file-size" *ngIf="data.file_size">({{ data.file_size }})</span>
                  </div>
                </div>

                <div *ngIf="data.data_type === 'image'" class="image-data-container">
                  <label>Image:</label>
                  <div class="image-info">
                    <div class="image-preview">
                      <img [src]="data.image_data"
                           [alt]="data.image_data_name"
                           (click)="viewImage(data.image_data)"
                           class="test-data-image">
                      <div class="image-name">{{ data.image_data_name }}</div>
                    </div>

                    <button class="view-full-btn" (click)="viewImage(data.image_data)">View Full Size</button>
                  </div>
                </div>

                <div *ngIf="data.data_type === 'other'" class="other-data-container">
                  <label>Other Data:</label>
                  <div class="other-data">{{ data.text_data || 'No data available' }}</div>
                </div>

                <div *ngIf="data.project" class="data-meta">
                  <small><strong>Project:</strong> {{ getProjectName(data.project) }}</small>
                </div>
              </div>

            </div>
          </div>
        </div>

        <div class="section card"
             *ngIf="(!testData || testData.length === 0) && testCase.test_data">
          <h3>Test Data</h3>
          <div class="section-content">
            <div class="no-test-data">
              <p>No test data files associated with this test case.</p>
            </div>
          </div>
        </div>

      </div>

      <!-- RIGHT COLUMN -->
      <div class="right-column">
        <!-- EXECUTION DETAILS -->
        <div class="section card" *ngIf="testCase.is_executed">
          <h3>Execution Details</h3>

          <div class="execution-details">
            <div class="detail-row">
              <label>Executed By:</label>
              <span>{{ getUserDisplayName(testCase.executed_by) }}</span>
            </div>

            <div class="detail-row">
              <label>Executed On:</label>
              <span>{{ testCase.executed_on | date:'medium' }}</span>
            </div>

            <div class="detail-row">
              <label>Actual Result:</label>
              <span class="actual-result">{{ testCase.actual_result || '-' }}</span>
            </div>
          </div>
        </div>

        <!-- BUG INFORMATION -->
        <div class="section card" *ngIf="testCase.bug_raised">
          <h3>Bug Information</h3>

          <div class="bug-details">
            <div class="detail-row">
              <label>Bug Status:</label>
              <span class="bug-status-badge {{ testCase.bug_status?.toLowerCase().replace(' ', '-') }}">
                {{ testCase.bug_status }}
              </span>
            </div>

            <!-- Multiple screenshots -->
            <div class="detail-row"
                 *ngIf="testCase.bug_screenshots && testCase.bug_screenshots.length > 0">
              <label>Bug Screenshots:</label>

              <div class="screenshots-container">
                <div class="screenshots-grid">
                  <div *ngFor="let screenshot of testCase.bug_screenshots; let i = index"
                       class="screenshot-thumbnail">

                    <img [src]="screenshot.screenshot_url"
                         [alt]="screenshot.screenshot_name || 'Bug Screenshot ' + (i + 1)"
                         (click)="openScreenshotViewer(i)"
                         class="bug-screenshot-thumb">

                    <div class="screenshot-overlay" (click)="openScreenshotViewer(i)">
                      <span class="view-icon">üëÅÔ∏è</span>
                    </div>
                  </div>
                </div>

                <div class="view-all-screenshots"
                     *ngIf="testCase.bug_screenshots.length > 1">
                  <button class="view-all-btn"
                          (click)="openScreenshotViewer(0)">
                    View All Screenshots ({{ testCase.bug_screenshots.length }})
                  </button>
                </div>
              </div>
            </div>

            <!-- Single screenshot fallback -->
            <div class="detail-row"
                 *ngIf="testCase.bug_screenshot &&
                       (!testCase.bug_screenshots || testCase.bug_screenshots.length === 0)">
              <label>Bug Screenshot:</label>

              <div class="screenshot-container">
                <img [src]="testCase.bug_screenshot"
                     alt="Bug Screenshot"
                     (click)="viewImage(testCase.bug_screenshot)"
                     class="bug-screenshot">

                <button class="view-full-btn"
                        (click)="viewImage(testCase.bug_screenshot)">
                  View Full Size
                </button>
              </div>
            </div>

          </div>
        </div>

        <!-- SYSTEM INFO -->
        <div class="section card">
          <h3>System Information</h3>

          <div class="system-info">
            <div class="detail-row">
              <label>Created:</label>
              <span>{{ testCase.created_at | date:'medium' }}</span>
            </div>

            <div class="detail-row" *ngIf="testCase.updated_at">
              <label>Last Updated:</label>
              <span>{{ testCase.updated_at | date:'medium' }}</span>
            </div>

            <div class="detail-row">
              <label>Created By:</label>
              <span>{{ getUserDisplayName(testCase.created_by) }}</span>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- HISTORY -->
    <div class="history-section" *ngIf="testCaseHistory && testCaseHistory.length > 0">
      <div class="section card full-width">
        <h3>Activity Timeline ({{ testCaseHistory.length }})</h3>

        <div class="history-container">
          <div class="history-timeline">
            <div *ngFor="let history of testCaseHistory; let i=index"
                 class="history-item">

              <div class="history-marker">
                <div class="history-dot"></div>
                <div class="history-line"
                     *ngIf="i !== testCaseHistory.length - 1"></div>
              </div>

              <div class="history-content">
                <div class="history-header">
                  <div class="history-user">
                    <strong>{{ getUserDisplayName(history.updated_by) }}</strong>
                    <span class="history-date">
                      {{ history.updated_on | date:'medium' }}
                    </span>
                  </div>

                  <div class="history-actions">
                    <span class="history-action">Updated Test Case</span>
                  </div>
                </div>

                <div class="history-details">
                  <div class="history-change" *ngIf="history.bug_status">
                    <label>Bug Status:</label>
                    <div class="change-content">
                      <span class="bug-status-badge {{ history.bug_status?.toLowerCase().replace(' ', '-') }}">
                        {{ history.bug_status }}
                      </span>
                    </div>
                  </div>

                  <div class="history-change" *ngIf="history.status">
                    <label>Test Status:</label>
                    <div class="change-content">
                      <span class="status-badge {{ history.status?.toLowerCase().replace(' ', '-') }}">
                        {{ history.status }}
                      </span>
                    </div>
                  </div>

                  <div class="history-change" *ngIf="history.comment">
                    <label>Comments:</label>
                    <div class="change-content">
                      <div class="history-comment">
                        {{ history.comment }}
                      </div>
                    </div>
                  </div>

                  <div class="history-change"
                       *ngIf="!history.bug_status && !history.status && !history.comment">
                    <label>Update:</label>
                    <div class="change-content">
                      <span class="no-changes">No specific changes recorded</span>
                    </div>
                  </div>

                </div>

              </div>

            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="history-section"
         *ngIf="testCaseHistory && testCaseHistory.length === 0">
      <div class="section card full-width">
        <h3>Activity Timeline</h3>
        <div class="no-history">
          <p>No activity recorded for this test case.</p>
          <p class="no-history-sub">
            Activities will appear here when changes are made to bug status,
            test status, or comments.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- IMAGE POPUP -->
  <div class="popup" *ngIf="showImagePopup">
    <div class="popup-content image-viewer">

      <div class="popup-header">
        <h3>Image Viewer</h3>
        <button class="close-btn" (click)="closeImagePopup()">‚úñ</button>
      </div>

      <div class="image-container">
        <img [src]="viewingImage"
             alt="Full size image"
             class="full-image">
      </div>

    </div>
  </div>

  <!-- SCREENSHOT VIEWER POPUP -->
  <div class="popup" *ngIf="showScreenshotViewer">
    <div class="popup-content screenshot-viewer">

      <div class="popup-header">
        <h3>Screenshot Viewer</h3>
        <div class="screenshot-counter" *ngIf="testCase.bug_screenshots && testCase.bug_screenshots.length > 1">
          {{ getScreenshotCounter() }}
        </div>
        <button class="close-btn" (click)="closeScreenshotViewer()">‚úñ</button>
      </div>

      <div class="screenshot-container-large">
        <button class="nav-btn prev-btn" (click)="prevScreenshot()" 
                *ngIf="testCase.bug_screenshots && testCase.bug_screenshots.length > 1">‚Äπ</button>
        
        <div class="screenshot-image-container">
          <img [src]="currentScreenshot?.screenshot_url" 
               [alt]="currentScreenshot?.screenshot_name || 'Bug Screenshot'"
               class="screenshot-full-image">
          <div class="screenshot-caption" *ngIf="currentScreenshot?.caption">
            {{ currentScreenshot.caption }}
          </div>
          <div class="screenshot-meta" *ngIf="currentScreenshot">
            <small>Uploaded by: {{ currentScreenshot.uploaded_by_name }} on {{ currentScreenshot.uploaded_at | date:'medium' }}</small>
          </div>
        </div>
        
        <button class="nav-btn next-btn" (click)="nextScreenshot()"
                *ngIf="testCase.bug_screenshots && testCase.bug_screenshots.length > 1">‚Ä∫</button>
      </div>

      <div class="screenshot-thumbnails" *ngIf="testCase.bug_screenshots && testCase.bug_screenshots.length > 1">
        <div *ngFor="let screenshot of testCase.bug_screenshots; let i = index" 
             class="thumbnail-item" 
             [class.active]="i === currentScreenshotIndex"
             (click)="openScreenshotViewer(i)">
          <img [src]="screenshot.screenshot_url" 
               [alt]="'Thumbnail ' + (i + 1)"
               class="thumbnail-image">
        </div>
      </div>

    </div>
  </div>
</div>